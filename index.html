<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heti | Monitoring Environment</title>
    <!-- Tailwind utility classes replaced with inline CSS for production -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
/* Reset and base styles */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html, body {
    height: 100%;
    overflow: hidden;
    font-size: 18px; /* Base font size increased from 16px for better readability */
}

/* Prevent text overflow globally */
h1, h2, h3, h4, h5, h6, p, span, div {
    overflow-wrap: break-word;
    word-wrap: break-word;
}

/* Paragraph base styles */
p {
    font-size: 1.125rem; /* 18px */
    line-height: 1.75; /* Better line height for readability */
}

/* Specific text size overrides for smaller UI elements */
.text-ui-small {
    font-size: 0.875rem;
}

.text-ui-tiny {
    font-size: 0.75rem;
}

/* Layout */
.flex { display: flex; }
.inline-flex { display: inline-flex; }
.flex-col { flex-direction: column; }
.flex-1 { flex: 1 1 0%; }
.flex-shrink-0 { flex-shrink: 0; }
.shrink-0 { flex-shrink: 0; }
.items-center { align-items: center; }
.items-start { align-items: flex-start; }
.justify-center { justify-content: center; }
.justify-between { justify-content: space-between; }

/* Grid */
.grid { display: grid; }
.grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
.grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
.grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }

/* Gap */
.gap-1 { gap: 0.25rem; }
.gap-2 { gap: 0.5rem; }
.gap-3 { gap: 0.75rem; }
.gap-4 { gap: 1rem; }
.gap-6 { gap: 1.5rem; }
.gap-8 { gap: 2rem; }
.gap-10 { gap: 2.5rem; }
.gap-12 { gap: 3rem; }
.gap-x-12 { column-gap: 3rem; }
.gap-y-6 { row-gap: 1.5rem; }

/* Spacing - Height */
.h-full { height: 100%; }
.h-screen { height: 100vh; }
.h-1\.5 { height: 0.375rem; }
.h-2 { height: 0.5rem; }
.h-8 { height: 2rem; }
.h-10 { height: 2.5rem; }
.h-16 { height: 4rem; }
.h-\[400px\] { height: 400px; }
.min-h-0 { min-height: 0; }

/* Spacing - Width */
.w-1\.5 { width: 0.375rem; }
.w-2 { width: 0.5rem; }
.w-8 { width: 2rem; }
.w-10 { width: 2.5rem; }
.w-80 { width: 20rem; }
.w-full { width: 100%; }
.max-w-5xl { max-width: 64rem; }

/* Padding */
.p-4 { padding: 1rem; }
.p-5 { padding: 1.25rem; }
.p-6 { padding: 1.5rem; }
.p-8 { padding: 2rem; }
.p-12 { padding: 3rem; }
.px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
.px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
.px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
.py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
.py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
.py-4 { padding-top: 1rem; padding-bottom: 1rem; }
.pb-6 { padding-bottom: 1.5rem; }
.pb-8 { padding-bottom: 2rem; }
.pt-4 { padding-top: 1rem; }
.pt-10 { padding-top: 2.5rem; }
.pt-16 { padding-top: 4rem; }

/* Margin */
.m-0 { margin: 0; }
.mx-auto { margin-left: auto; margin-right: auto; }
.mb-1 { margin-bottom: 0.25rem; }
.mb-2 { margin-bottom: 0.5rem; }
.mb-4 { margin-bottom: 1rem; }
.mb-6 { margin-bottom: 1.5rem; }
.mb-8 { margin-bottom: 2rem; }
.mb-10 { margin-bottom: 2.5rem; }
.mb-12 { margin-bottom: 3rem; }
.mt-1 { margin-top: 0.25rem; }
.mt-1\.5 { margin-top: 0.375rem; }
.mt-2 { margin-top: 0.5rem; }
.mt-6 { margin-top: 1.5rem; }
.mt-8 { margin-top: 2rem; }
.mt-10 { margin-top: 2.5rem; }

/* Space Between */
.space-y-1 > * + * { margin-top: 0.25rem; }
.space-y-2 > * + * { margin-top: 0.5rem; }
.space-y-4 > * + * { margin-top: 1rem; }
.space-y-6 > * + * { margin-top: 1.5rem; }
.space-y-8 > * + * { margin-top: 2rem; }
.space-y-12 > * + * { margin-top: 3rem; }
.space-y-16 > * + * { margin-top: 4rem; }

/* Typography - INCREASED FONT SIZES */
.text-xs { font-size: 1rem; line-height: 1.5rem; } /* Increased from 0.875rem */
.text-sm { font-size: 1.125rem; line-height: 1.75rem; } /* Increased from 1rem */
.text-lg { font-size: 1.375rem; line-height: 2rem; } /* Increased from 1.25rem */
.text-xl { font-size: 1.5rem; line-height: 2rem; } /* Increased from 1.375rem */
.text-2xl { font-size: 1.75rem; line-height: 2.5rem; } /* Increased from 1.625rem */
.text-4xl { font-size: 2.75rem; line-height: 3rem; } /* Increased from 2.5rem */
.text-\[10px\] { font-size: 14px; } /* Increased from 13px */
.text-\[11px\] { font-size: 15px; } /* Increased from 14px */

.font-bold { font-weight: 700; }
.font-semibold { font-weight: 600; }
.font-medium { font-weight: 500; }
.font-extrabold { font-weight: 800; }
.font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

.uppercase { text-transform: uppercase; }
.tracking-tight { letter-spacing: -0.025em; }
.tracking-wider { letter-spacing: 0.05em; }
.tracking-widest { letter-spacing: 0.1em; }
.leading-relaxed { line-height: 1.625; }

.text-left { text-align: left; }
.text-center { text-align: center; }
.italic { font-style: italic; }
.whitespace-nowrap { white-space: nowrap; }

/* Text Colors */
.text-white { color: #ffffff; }
.text-gray-400 { color: #9ca3af; }
.text-slate-200 { color: #e2e8f0; }
.text-slate-300 { color: #cbd5e1; }
.text-slate-400 { color: #94a3b8; }
.text-slate-500 { color: #64748b; }
.text-slate-600 { color: #475569; }
.text-slate-700 { color: #334155; }
.text-slate-800 { color: #1e293b; }
.text-slate-900 { color: #0f172a; }
.text-amber-400 { color: #fbbf24; }
.text-amber-500 { color: #f59e0b; }
.text-amber-600 { color: #d97706; }
.text-amber-700 { color: #b45309; }
.text-amber-800 { color: #92400e; }
.text-blue-400 { color: #60a5fa; }
.text-blue-600 { color: #2563eb; }
.text-blue-800 { color: #1e40af; }
.text-rose-400 { color: #fb7185; }
.text-rose-500 { color: #f43f5e; }
.text-rose-600 { color: #e11d48; }
.text-rose-700 { color: #be123c; }
.text-violet-600 { color: #7c3aed; }
.text-indigo-400 { color: #818cf8; }
.text-indigo-600 { color: #4f46e5; }
.text-indigo-700 { color: #4338ca; }
.text-emerald-50 { color: #ecfdf5; }
.text-emerald-400 { color: #34d399; }
.text-emerald-500 { color: #10b981; }
.text-emerald-600 { color: #059669; }
.text-emerald-700 { color: #047857; }
.text-emerald-800 { color: #065f46; }

/* Background Colors */
.bg-white { background-color: #ffffff; }
.bg-black { background-color: #000000; }
.bg-slate-50 { background-color: #f8fafc; }
.bg-slate-100 { background-color: #f1f5f9; }
.bg-slate-400 { background-color: #94a3b8; }
.bg-slate-500 { background-color: #64748b; }
.bg-slate-800 { background-color: #1e293b; }
.bg-slate-900 { background-color: #0f172a; }
.bg-amber-50 { background-color: #fffbeb; }
.bg-amber-100 { background-color: #fef3c7; }
.bg-blue-50 { background-color: #eff6ff; }
.bg-blue-100 { background-color: #dbeafe; }
.bg-rose-100 { background-color: #ffe4e6; }
.bg-violet-100 { background-color: #ede9fe; }
.bg-indigo-100 { background-color: #e0e7ff; }
.bg-emerald-50 { background-color: #ecfdf5; }
.bg-emerald-100 { background-color: #d1fae5; }
.bg-white\/10 { background-color: rgba(255, 255, 255, 0.1); }

/* Gradients */
.bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }
.bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--tw-gradient-stops)); }
.from-slate-50 { --tw-gradient-from: #f8fafc; --tw-gradient-to: rgba(248, 250, 252, 0); --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to); }
.from-emerald-500 { --tw-gradient-from: #10b981; --tw-gradient-to: rgba(16, 185, 129, 0); --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to); }
.to-blue-50 { --tw-gradient-to: #eff6ff; }
.to-teal-500 { --tw-gradient-to: #14b8a6; }

/* Borders */
.border { border-width: 1px; border-style: solid; border-color: #e2e8f0; }
.border-b { border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #e2e8f0; }
.border-t { border-top-width: 1px; border-top-style: solid; border-top-color: #e2e8f0; }
.border-r { border-right-width: 1px; border-right-style: solid; border-right-color: #e2e8f0; }
.border-2 { border-width: 2px; }
.border-l-4 { border-left-width: 4px; }
.border-slate-200 { border-color: #e2e8f0; }
.border-slate-400 { border-color: #94a3b8; }
.border-amber-100 { border-color: #fef3c7; }
.border-blue-100 { border-color: #dbeafe; }
.border-rose-200 { border-color: #fecdd3; }
.border-emerald-100 { border-color: #d1fae5; }
.border-l-blue-500 { border-left-color: #3b82f6; }
.border-l-violet-500 { border-left-color: #8b5cf6; }
.border-l-emerald-500 { border-left-color: #10b981; }

/* Divide */
.divide-y > * + * { border-top-width: 1px; }
.divide-slate-100 > * + * { border-color: #f1f5f9; }

/* Border Radius */
.rounded { border-radius: 0.25rem; }
.rounded-lg { border-radius: 0.5rem; }
.rounded-xl { border-radius: 0.75rem; }
.rounded-2xl { border-radius: 1rem; }
.rounded-3xl { border-radius: 1.5rem; }
.rounded-full { border-radius: 9999px; }

/* Shadows */
.shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
.shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }

/* Effects */
.opacity-75 { opacity: 0.75; }
.backdrop-blur-sm { backdrop-filter: blur(4px); }

/* Overflow */
.overflow-hidden { overflow: hidden; }
.overflow-x-hidden { overflow-x: hidden; }
.overflow-x-auto { overflow-x: auto; }
.overflow-y-auto { overflow-y: auto; }

/* Position */
.relative { position: relative; }
.absolute { position: absolute; }
.fixed { position: fixed; }

/* Z-Index */
.z-50 { z-index: 50; }

/* Display */
.hidden { display: none; }

/* Lists */
.list-disc { list-style-type: disc; }
.list-inside { list-style-position: inside; }

/* Transitions */
.transition { 
    transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; 
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); 
    transition-duration: 150ms; 
}

/* Hover States */
.hover\:text-gray-600:hover { color: #4b5563; }
.hover\:bg-slate-50:hover { background-color: #f8fafc; }
.hover\:bg-slate-800:hover { background-color: #1e293b; }
.hover\:bg-slate-900:hover { background-color: #0f172a; }
.hover\:bg-rose-50:hover { background-color: #fff1f2; }

/* Animations */
.animate-ping {
    animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
}

@keyframes ping {
    75%, 100% {
        transform: scale(2);
        opacity: 0;
    }
}

/* Responsive Design */
@media (min-width: 768px) {
    .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
}


        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }

        /* Animated environment background */
        #env-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.6s ease;
        }
        #env-canvas.visible {
            opacity: 1;
        }

        /* Zone indicator badge */
        .zone-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding: 2px 7px;
            border-radius: 20px;
            margin-top: 4px;
            transition: background 0.3s, color 0.3s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .zone-badge .zone-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .zone-badge.optimal {
            background: #d1fae5;
            color: #065f46;
        }
        .zone-badge.optimal .zone-dot { background: #10b981; }
        .zone-badge.warning {
            background: #fef3c7;
            color: #92400e;
        }
        .zone-badge.warning .zone-dot { background: #f59e0b; }
        .zone-badge.critical {
            background: #ffe4e6;
            color: #be123c;
        }
        .zone-badge.critical .zone-dot { background: #f43f5e; }

        /* Color-coded slider tracks via pseudo-element gradient fills */
        .slider-wrap { 
            position: relative;
            display: flex;
            align-items: center;
            height: 24px;
        }
        .slider-wrap input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: transparent;
            outline: none;
            position: relative;
            z-index: 1;
            margin: 0;
        }
        .slider-wrap input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #1e293b;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }
        .slider-wrap input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #1e293b;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border: none;
        }
        /* The gradient track sits behind the native range input */
        .slider-track {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 6px;
            border-radius: 3px;
            transform: translateY(-50%);
            z-index: 0;
            pointer-events: none;
            transition: background 0.25s;
            background: #e2e8f0;
        }
        /* Black fill showing slider progress */
        .slider-fill {
            position: absolute;
            top: 50%;
            left: 0;
            height: 6px;
            border-radius: 3px;
            transform: translateY(-50%);
            z-index: 0;
            pointer-events: none;
            background: #000;
            transition: width 0.15s ease;
        }

        /* On mobile touch targets keep working */
        @media (max-width: 768px) {
            .slider-wrap input[type="range"] {
                height: 12px;
                padding: 8px 0;
            }
            .slider-track {
                height: 6px;
            }
        }

        .stat-card {
            transition: transform 0.2s ease;
            overflow: hidden;
        }
        
        .stat-card p {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .tab-active {
            color: #000 !important;
            border-bottom: 2px solid #000;
        }

        .hidden-section {
            display: none !important;
        }

        .formula-box {
            background: #f1f5f9;
            border-left: 4px solid #000;
            padding: 1rem;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            margin: 1rem 0;
            border-radius: 0 0.5rem 0.5rem 0;
            overflow-x: auto;
            word-wrap: break-word;
        }
        
        .concept-card {
            border: 1px solid #f1f5f9;
            padding: 1.5rem;
            border-radius: 1rem;
            background: #fff;
        }
        
        /* Ensure Operational Theory subtitle stays within border */
        #section-concept > div > header {
            display: flex;
            flex-direction: column;
        }
        
        #section-concept > div > header h2 {
            order: 1;
        }
        
        #section-concept > div > header p {
            order: 2;
            margin-top: 0;
        }

        .physics-tag {
            background: #e2e8f0;
            color: #475569;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .control-layer {
            border-left: 2px solid #e2e8f0;
            padding-left: 1.5rem;
            position: relative;
        }
        .control-layer::before {
            content: '';
            position: absolute;
            left: -5px;
            top: 0;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #cbd5e1;
        }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { text-align: left; padding: 12px; font-size: 11px; color: #64748b; border-bottom: 2px solid #f1f5f9; text-transform: uppercase; overflow: hidden; text-overflow: ellipsis; }
        td { padding: 12px; font-size: 16px; border-bottom: 1px solid #f1f5f9; overflow: hidden; text-overflow: ellipsis; }

        /* Tooltip styles - now works on mobile with tap */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        .tooltip-icon {
            cursor: pointer;
            color: #94a3b8;
            font-size: 14px;
            margin-left: 4px;
            padding: 4px;
        }
        .tooltip-text {
            visibility: hidden;
            width: 220px;
            max-width: 90vw;
            background-color: #1e293b;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 10px 14px;
            position: fixed;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 15px;
            line-height: 1.5;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .tooltip-container:hover .tooltip-text,
        .tooltip-container.active .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1e293b;
            color: white;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background: #059669;
        }
        
        .toast.error {
            background: #dc2626;
        }
        
        /* ‚îÄ‚îÄ‚îÄ Mobile Preferences Popup (FAB hint) ‚îÄ‚îÄ‚îÄ */
        .mobile-pref-popup {
            display: none;                       /* hidden until .show */
            position: fixed;
            bottom: 94px;                        /* sit just above the FAB */
            right: 24px;
            z-index: 10005;
            width: 200px;
        }

        .mobile-pref-popup.show {
            display: block;
            animation: popupSlideUp 0.35s cubic-bezier(.22,.68,0,1.2) forwards;
        }

        @keyframes popupSlideUp {
            from { opacity: 0; transform: translateY(14px); }
            to   { opacity: 1; transform: translateY(0);    }
        }

        /* The bubble card itself */
        .mobile-pref-popup .bubble {
            background: #1e293b;
            color: #fff;
            border-radius: 14px;
            padding: 14px 15px 14px 14px;
            font-size: 13.5px;
            font-weight: 600;
            line-height: 1.45;
            box-shadow: 0 6px 20px rgba(0,0,0,.35);
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        /* Pointer arrow pointing down-right towards the FAB */
        .mobile-pref-popup .bubble::after {
            content: "";
            position: absolute;
            bottom: -9px;
            right: 22px;
            width: 0; height: 0;
            border-left:  9px solid transparent;
            border-right: 9px solid transparent;
            border-top:   9px solid #1e293b;
        }

        /* Gear icon circle */
        .mobile-pref-popup .bubble .pop-icon {
            width: 32px; height: 32px;
            min-width: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,.12);
            display: flex; align-items: center; justify-content: center;
            font-size: 15px;
        }

        /* Close √ó */
        .mobile-pref-popup .bubble .pop-close {
            position: absolute;
            top: 6px; right: 7px;
            background: rgba(255,255,255,.18);
            border: none;
            color: #fff;
            width: 22px; height: 22px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 13px;
            line-height: 22px;
            text-align: center;
            padding: 0;
        }

        /* Subtle ring-pulse on the FAB while popup is visible */
        .mobile-pref-popup.show ~ .mobile-menu-btn {
            box-shadow: 0 0 0 0 rgba(30,41,59,.5);
            animation: fabRing 1.8s ease-in-out 0.3s infinite;
        }
        @keyframes fabRing {
            0%   { box-shadow: 0 0 0 0   rgba(30,41,59,.5); }
            70%  { box-shadow: 0 0 0 12px rgba(30,41,59,0); }
            100% { box-shadow: 0 0 0 0   rgba(30,41,59,0); }
        }

        /* Only visible on mobile */
        @media (min-width: 769px) {
            .mobile-pref-popup { display: none !important; }
        }
        
        /* Onboarding Tutorial Overlay */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        
        .onboarding-overlay.active {
            display: flex;
        }
        
        /* Make overlay non-blocking during interactive step */
        .onboarding-overlay.interactive {
            pointer-events: none;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(2px);
            z-index: 9998; /* Lower than sidebar during interactive mode */
        }
        
        .onboarding-overlay.interactive .onboarding-card {
            pointer-events: auto;
            z-index: 10004; /* Above everything */
        }
        
        .onboarding-card {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            position: relative;
            animation: slideUp 0.4s ease;
        }
        
        /* Position card to right during interactive step */
        .onboarding-overlay.interactive .onboarding-card {
            position: fixed;
            right: 24px;
            bottom: 100px;
            top: auto;
            max-width: 400px;
        }
        
        @media (max-width: 768px) {
            .onboarding-overlay.interactive .onboarding-card {
                right: 50%;
                transform: translateX(50%);
                bottom: 24px;
                max-width: 90%;
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .onboarding-step {
            display: none;
        }
        
        .onboarding-step.active {
            display: block;
        }
        
        .onboarding-dots {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 24px;
        }
        
        .onboarding-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e2e8f0;
            transition: all 0.3s;
        }
        
        .onboarding-dot.active {
            background: #000;
            width: 24px;
            border-radius: 4px;
        }
        
        .quick-start-cta {
            background: linear-gradient(135deg, #000 0%, #374151 100%);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            border: none;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .quick-start-cta:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .skip-tutorial {
            color: #64748b;
            font-size: 14px;
            margin-top: 16px;
            cursor: pointer;
            text-align: center;
            text-decoration: underline;
        }
        
        .skip-tutorial:hover {
            color: #334155;
        }
        
        /* Spotlight effect for highlighting elements */
        .spotlight {
            position: fixed;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        /* Interactive hint pulse */
        .hint-pulse {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
            z-index: 10002;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 0.5;
            }
        }
        
        /* Welcome banner */
        .welcome-banner {
            background: linear-gradient(135deg, #000 0%, #1e293b 100%);
            color: white;
            padding: 20px 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: none;
        }
        
        .welcome-banner.show {
            display: block;
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .welcome-banner h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .welcome-banner p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .onboarding-card {
                padding: 32px 24px;
                max-width: 90%;
            }
        }
        
        .goal-option:hover {
            border-color: #94a3b8 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Battery status indicator */
        .battery-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .battery-charging {
            background: #d1fae5;
            color: #065f46;
        }
        .battery-discharging {
            background: #fef3c7;
            color: #92400e;
        }
        .battery-idle {
            background: #e2e8f0;
            color: #475569;
        }

        /* Preset buttons */
        .preset-btn {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
            background: white;
        }
        .preset-btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        /* Glossary styles */
        .glossary-term {
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 4px;
        }
        .glossary-def {
            color: #64748b;
            font-size: 13px;
            margin-bottom: 12px;
            padding-left: 12px;
            border-left: 2px solid #e2e8f0;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            /* Mobile fixes for concept section */
            #concept-container {
                padding: 1.5rem 1rem !important;
            }
            
            /* Mobile styles for definition box */
            #concept-container > div:first-child {
                padding: 1.5rem !important;
                margin-bottom: 2.5rem !important;
            }
            
            #concept-container > div:first-child h2 {
                font-size: 1.5rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            #concept-container > div:first-child p {
                font-size: 0.95rem !important;
                line-height: 1.6 !important;
            }
            
            /* Make tables horizontally scrollable on mobile */
            .overflow-x-auto {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
                width: 100%;
            }
            
            .overflow-x-auto table {
                min-width: 800px;
            }
            
            /* Ensure table cells don't wrap on mobile */
            .overflow-x-auto table td,
            .overflow-x-auto table th {
                white-space: normal;
                min-width: 150px;
            }
            
            .overflow-x-auto table td:last-child {
                min-width: 300px;
            }
            
            /* Add scrollbar styling for better UX */
            .overflow-x-auto::-webkit-scrollbar {
                height: 8px;
            }
            
            .overflow-x-auto::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 4px;
            }
            
            .overflow-x-auto::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 4px;
            }
            
            .overflow-x-auto::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }
            
            aside {
                position: fixed;
                top: 0;
                left: 0;
                width: 85%;
                max-width: 400px;
                height: 100vh;
                background: white;
                z-index: 10002;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                border-right: 1px solid #e2e8f0;
                overflow-y: auto;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            
            aside.mobile-open {
                transform: translateX(0);
            }
            
            /* Mobile overlay */
            .mobile-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 10001;
            }
            
            .mobile-overlay.active {
                display: block;
            }
            
            /* Mobile hamburger button */
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                position: fixed;
                bottom: 24px;
                right: 24px;
                width: 56px;
                height: 56px;
                background: #000;
                color: white;
                border-radius: 50%;
                border: none;
                font-size: 20px;
                cursor: pointer;
                z-index: 10004;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transition: transform 0.2s ease;
            }
            
            .mobile-menu-btn:active {
                transform: scale(0.95);
            }
            
            /* Fix header layout on mobile to prevent overlapping */
            header {
                padding: 6px 10px;
                height: 48px;
                min-height: 48px;
                position: sticky;
                top: 0;
                z-index: 100;
                background: white;
                border-bottom: 1px solid #e2e8f0;
                display: flex !important;
                align-items: center;
                justify-content: space-between;
                gap: 4px;
            }
            
            /* Make logo smaller and compact on mobile */
            header > div:first-child {
                flex: 0 0 auto;
                gap: 6px !important;
            }
            
            header .w-8.h-8 {
                width: 28px !important;
                height: 28px !important;
                font-size: 14px;
            }
            
            header h1 {
                font-size: 15px !important;
            }
            
            /* Navigation tabs - compact in center */
            header nav {
                flex: 0 0 auto;
                display: flex !important;
                gap: 8px !important;
                height: 100% !important;
                align-items: center;
            }
            
            header nav button {
                font-size: 9px !important;
                padding: 4px 8px !important;
                height: auto !important;
                white-space: nowrap;
                letter-spacing: 0.05em !important;
            }
            
            /* Export button - compact on right */
            header > div:last-child {
                flex: 0 0 auto;
            }
            
            #btn-export {
                display: inline-flex !important;
                font-size: 8px !important;
                padding: 4px 6px !important;
                min-width: 45px !important;
                height: 26px !important;
                white-space: nowrap;
                align-items: center;
                justify-content: center;
            }
            
            #btn-export i {
                font-size: 8px;
                margin-right: 2px;
            }
            
            #btn-export.hidden {
                display: none !important;
            }
            
            /* Ensure main content doesn't overlap with header */
            main {
                margin-top: 0;
                height: calc(100vh - 48px);
            }
            
            /* Increase font sizes for mobile */
            body {
                font-size: 18px;
            }
            
            p {
                font-size: 1.125rem;
                line-height: 1.75;
            }
            
            th {
                font-size: 15px;
                padding: 14px;
            }
            
            td {
                font-size: 17px;
                padding: 14px;
            }
            
            .stat-card h3 {
                font-size: 13px;
            }
            
            /* ‚îÄ‚îÄ‚îÄ Side-by-side stat cards on mobile ‚îÄ‚îÄ‚îÄ */
            .stats-grid-mobile {
                display: flex !important;
                flex-direction: row !important;
                gap: 8px !important;
                /* let cards shrink equally */
            }
            .stats-grid-mobile > .stat-card {
                flex: 1 1 0;   /* equal width columns */
                min-width: 0;  /* allow text to truncate if needed */
            }
            .stat-card-mobile {
                padding: 10px 8px !important;
            }
            .stat-card-mobile p.text-2xl {
                font-size: 1.35rem !important;
                line-height: 1.3 !important;
                white-space: nowrap;
            }
            .stat-card-mobile p[class*="text-[10px]"] {
                font-size: 9.5px !important;
                margin-bottom: 3px !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .stat-card-mobile .zone-badge {
                font-size: 8px !important;
                padding: 2px 6px !important;
            }
            
            /* Make charts taller on mobile */
            .chart-container-mobile {
                height: 450px !important;
            }
            
            #pwrChart, #socChart {
                min-height: 300px !important;
            }
            
            /* Improve button tap targets */
            .preset-btn {
                padding: 14px 18px;
                font-size: 13px;
                min-height: 44px;
            }
            
            button {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Better slider touch targets */
            input[type="range"] {
                height: 12px;
                padding: 8px 0;
            }
            
            /* Mobile tab improvements */
            .tab-button {
                padding: 14px 18px;
                font-size: 14px;
            }
            
            /* Mobile table improvements */
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            th {
                font-size: 9px !important;
                padding: 8px !important;
            }
            
            td {
                font-size: 12px !important;
                padding: 8px !important;
            }
            
            td .font-mono {
                font-size: 10px !important;
            }
            
            td span.px-3 {
                font-size: 9px !important;
                padding: 2px 6px !important;
            }
            
            /* Concept page mobile adjustments */
            .formula-box {
                font-size: 0.75rem !important;
                padding: 0.75rem !important;
            }
            
            .concept-card {
                padding: 1rem !important;
            }
            
            .concept-card h4 {
                font-size: 0.875rem !important;
            }
            
            .concept-card p {
                font-size: 0.75rem !important;
            }
            
            /* Better wrapping for long words */
            .font-mono {
                word-break: break-all;
            }
            
            /* Operational Theory section mobile fixes */
            #section-concept > div {
                padding: 1.5rem 1rem !important;
            }
            
            /* Header with border - subtitle must be inside the border area */
            #section-concept > div > header {
                margin-bottom: 2.5rem !important;  /* Gap AFTER the border line */
                padding-bottom: 1.25rem !important;  /* Space inside for subtitle */
                position: static !important;
                display: flex !important;
                flex-direction: column !important;
                border-bottom: 1px solid #e2e8f0 !important;
            }
            
            #section-concept > div > header h2 {
                font-size: 1.75rem !important;
                margin-bottom: 0.75rem !important;
                line-height: 1.2;
                display: block !important;
                width: 100%;
            }
            
            #section-concept > div > header p {
                font-size: 0.95rem !important;
                line-height: 1.5;
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100%;
            }
            
            /* Section spacing between Solar, Wind, Load sections */
            #section-concept .space-y-16 > * + * {
                margin-top: 2.5rem !important;
            }
            
            /* Ensure content scrolls normally - not sticky */
            #section-concept {
                position: relative !important;
            }
            
            /* Mathematical equation mobile adjustment */
            .bg-slate-800 .font-mono {
                font-size: 0.65rem !important;
            }
            
            /* Reduce heading sizes on mobile concept page */
            h2.text-2xl {
                font-size: 1.25rem !important;
            }
            
            h3.text-xl {
                font-size: 1.1rem !important;
            }
            
            h3.text-lg {
                font-size: 1rem !important;
            }
        }
        
        /* Mobile landscape ‚Äì short viewports (e.g. phone turned sideways) */
        @media (max-width: 768px) and (orientation: landscape) and (max-height: 500px) {
            header {
                height: 40px;
                min-height: 40px;
                padding: 4px 10px;
            }
            main {
                height: calc(100vh - 40px);
            }
            /* Shrink stat cards into a single compact row */
            .stats-grid-mobile {
                display: flex !important;
                flex-direction: row !important;
                gap: 6px !important;
            }
            .stat-card-mobile {
                padding: 6px 7px !important;
            }
            .stat-card-mobile p.text-2xl {
                font-size: 1.05rem !important;
                line-height: 1.25 !important;
            }
            .stat-card-mobile p[class*="text-[10px]"] {
                font-size: 8px !important;
                margin-bottom: 1px !important;
            }
            .stat-card-mobile .zone-badge {
                font-size: 7px !important;
                padding: 1px 5px !important;
            }
            /* Compress chart containers */
            .chart-container-mobile {
                height: 180px !important;
                padding: 10px 12px !important;
            }
            .chart-container-mobile h3 {
                font-size: 11px !important;
                margin-bottom: 4px !important;
            }
            /* Tighter sidebar */
            aside {
                max-width: 260px !important;
            }
            .sidebar-content {
                padding: 10px 14px !important;
            }
            .sidebar-content .space-y-6 > * + * {
                margin-top: 10px !important;
            }
            .preset-btn {
                padding: 8px 10px !important;
                min-height: 34px !important;
                font-size: 10px !important;
            }
            /* FAB stays but shrinks */
            .mobile-menu-btn {
                width: 44px !important;
                height: 44px !important;
                bottom: 14px !important;
                right: 14px !important;
                font-size: 17px !important;
            }
        }

        /* Desktop - hide mobile menu button */
        @media (min-width: 769px) {
            .mobile-menu-btn {
                display: none;
            }
            
            .mobile-overlay {
                display: none !important;
            }
            
            /* Keep sidebar visible on desktop */
            aside {
                position: relative !important;
                transform: none !important;
                width: 320px;
                flex-shrink: 0;
            }
        }
        
        .mobile-toggle-btn {
            display: none;
        }
        
        /* Ensure mobile menu button is visible on mobile */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex !important;
                align-items: center;
                justify-content: center;
            }
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">
    <!-- Animated environment background -->
    <canvas id="env-canvas"></canvas>

    <!-- Onboarding Tutorial Overlay -->
    <div class="onboarding-overlay" id="onboarding-overlay">
        <div class="onboarding-card">
            <!-- Step 1: Welcome -->
            <div class="onboarding-step active" data-step="1">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚ö°</div>
                    <h2 style="font-size: 28px; font-weight: 800; margin-bottom: 12px; color: #0f172a;">Welcome to Heti!</h2>
                    <p style="font-size: 16px; color: #64748b; line-height: 1.6; margin-bottom: 24px;">
                        Your interactive microgrid simulator. Let's get you started with a quick 30-second tour.
                    </p>
                </div>
                <button class="quick-start-cta" onclick="nextOnboardingStep()">
                    Start Quick Tour ‚Üí
                </button>
                <div class="skip-tutorial" onclick="skipTutorial()">Skip and explore on my own</div>
            </div>
            
            <!-- Step 2: Goal Setting -->
            <div class="onboarding-step" data-step="2">
                <h2 style="font-size: 24px; font-weight: 800; margin-bottom: 16px; color: #0f172a;">What would you like to optimize?</h2>
                <p style="font-size: 15px; color: #64748b; margin-bottom: 24px;">Choose your goal - you can change this anytime:</p>
                
                <div style="display: grid; gap: 12px; margin-bottom: 24px;">
                    <button class="goal-option" data-goal="savings" onclick="selectGoal('savings')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; text-align: left; cursor: pointer; transition: all 0.2s; background: white;">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px; color: #0f172a;">üí∞ Maximum Cost Savings</div>
                        <div style="font-size: 13px; color: #64748b;">Reduce your electricity bill as much as possible</div>
                    </button>
                    
                    <button class="goal-option" data-goal="independence" onclick="selectGoal('independence')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; text-align: left; cursor: pointer; transition: all 0.2s; background: white;">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px; color: #0f172a;">üîã Energy Independence</div>
                        <div style="font-size: 13px; color: #64748b;">Minimize reliance on the power grid</div>
                    </button>
                    
                    <button class="goal-option" data-goal="reliability" onclick="selectGoal('reliability')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; text-align: left; cursor: pointer; transition: all 0.2s; background: white;">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px; color: #0f172a;">‚ö° Backup Reliability</div>
                        <div style="font-size: 13px; color: #64748b;">Ensure power during outages and storms</div>
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Interactive Demo -->
            <div class="onboarding-step" data-step="3">
                <h2 style="font-size: 24px; font-weight: 800; margin-bottom: 16px; color: #0f172a;">Try it yourself!</h2>
                <p style="font-size: 15px; color: #64748b; margin-bottom: 24px;">
                    <span id="demo-instruction">Move the Solar Intensity slider and watch the savings change in real-time.</span>
                </p>
                
                <div style="background: #f8fafc; padding: 24px; border-radius: 12px; border: 2px dashed #cbd5e1; margin-bottom: 20px;">
                    <div style="text-align: center; font-size: 48px; margin-bottom: 16px;" id="demo-icon">‚òÄÔ∏è</div>
                    <div style="text-align: center; font-size: 14px; color: #64748b; font-weight: 600;">
                        <span id="demo-hint">Adjust the sliders in the left panel ‚Üí</span>
                    </div>
                </div>
                
                <button class="quick-start-cta" onclick="nextOnboardingStep()" id="continue-btn" style="opacity: 0.5; cursor: not-allowed;" disabled>
                    Continue (adjust a slider first)
                </button>
            </div>
            
            <!-- Step 4: Quick Scenarios -->
            <div class="onboarding-step" data-step="4">
                <h2 style="font-size: 24px; font-weight: 800; margin-bottom: 16px; color: #0f172a;">Try Quick Scenarios</h2>
                <p style="font-size: 15px; color: #64748b; margin-bottom: 24px;">
                    Don't want to adjust every slider? Use preset scenarios:
                </p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
                    <div style="padding: 16px; background: #fef3c7; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 8px;">‚òÄÔ∏è</div>
                        <div style="font-weight: 700; font-size: 14px; color: #92400e;">Sunny Day</div>
                    </div>
                    <div style="padding: 16px; background: #dbeafe; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 8px;">‚òÅÔ∏è</div>
                        <div style="font-weight: 700; font-size: 14px; color: #1e40af;">Cloudy Day</div>
                    </div>
                    <div style="padding: 16px; background: #fee2e2; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 8px;">‚ö°</div>
                        <div style="font-weight: 700; font-size: 14px; color: #991b1b;">High Demand</div>
                    </div>
                    <div style="padding: 16px; background: #e0e7ff; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 8px;">üåô</div>
                        <div style="font-weight: 700; font-size: 14px; color: #3730a3;">Nighttime</div>
                    </div>
                </div>
                
                <p style="font-size: 13px; color: #64748b; margin-bottom: 20px; text-align: center;">
                    Look for these in the "Quick Scenarios" section below the sliders
                </p>
                
                <button class="quick-start-cta" onclick="finishOnboarding()">
                    Start Exploring! üöÄ
                </button>
            </div>
            
            <!-- Progress dots -->
            <div class="onboarding-dots">
                <div class="onboarding-dot active"></div>
                <div class="onboarding-dot"></div>
                <div class="onboarding-dot"></div>
                <div class="onboarding-dot"></div>
            </div>
        </div>
    </div>
    
    <!-- Mobile overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>
    
    <!-- Mobile Preferences Popup (points user to the FAB) -->
    <div class="mobile-pref-popup" id="mobile-pref-popup">
        <div class="bubble">
            <div class="pop-icon"><i class="fa-solid fa-sliders"></i></div>
            <div style="padding-right:18px;">Tap here to open<br><strong>Preferences</strong> &amp; adjust simulation values</div>
            <button class="pop-close" onclick="closeMobilePrefPopup()" aria-label="Close">√ó</button>
        </div>
    </div>
    
    <!-- Mobile menu button -->
    <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Toggle menu">
        <i class="fa-solid fa-sliders"></i>
    </button>
    
    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Header -->
    <header class="h-16 border-b bg-white flex items-center justify-between px-6 shrink-0 z-50">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-black rounded flex items-center justify-center text-white font-bold">H</div>
            <div>
                <h1 class="text-lg font-bold tracking-tight">Heti</h1>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <nav class="flex h-full gap-8" role="navigation" aria-label="Main navigation">
            <button onclick="switchTab('concept')" id="tab-concept" class="h-full px-2 text-xs font-bold uppercase tracking-widest transition tab-active" style="background: white; border: none;" role="tab" aria-selected="true" aria-controls="section-concept" tabindex="0">
                Concept
            </button>
            <button onclick="switchTab('simulation')" id="tab-simulation" class="h-full px-2 text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-gray-600 transition" style="background: white; border: none;" role="tab" aria-selected="false" aria-controls="section-simulation" tabindex="0">
                Simulation
            </button>
        </nav>

        <div class="flex items-center gap-4">
            <button id="btn-export" class="px-3 py-1 rounded-lg bg-black text-white text-[10px] font-bold uppercase tracking-wider hover:bg-slate-800 transition hidden" style="min-width: 90px; height: 36px;">
                <i class="fa-solid fa-download"></i> Export
            </button>
        </div>
    </header>

    <!-- Content Area -->
    <main class="flex-1 relative overflow-hidden bg-slate-50">
        
        <!-- SECTION: CONCEPT -->
        <div id="section-concept" class="h-full overflow-y-auto bg-white custom-scroll" role="tabpanel" aria-labelledby="tab-concept">
            <div class="max-w-5xl mx-auto p-12" id="concept-container">
                <!-- Microgrid Definition Box -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem; border-radius: 1rem; margin-bottom: 3rem; box-shadow: 0 10px 30px rgba(0,0,0,0.15);">
                    <h2 style="color: white; font-size: 1.75rem; font-weight: 800; margin-bottom: 1rem; line-height: 1.3;">What is a microgrid?</h2>
                    <p style="color: rgba(255,255,255,0.95); font-size: 1.05rem; line-height: 1.7; margin: 0;">Microgrids are small-scale power grids that operate independently to generate electricity for a localized area, such as a university campus, hospital complex, military base or geographical region.</p>
                </div>

                <div class="space-y-16">
                    <!-- 1. Solar Power Forecasting -->
                    <section>
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-lg bg-amber-100 text-amber-600 flex items-center justify-center font-bold text-lg">1</div>
                            <h3 class="text-2xl font-bold text-slate-800">Solar Power Forecasting: Beyond Irradiance</h3>
                        </div>
                        <p class="text-slate-600 mb-6 leading-relaxed">While irradiance is the "fuel," the actual output is a result of complex energy conversion. Heti utilizes a Hybrid Approach:</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="concept-card">
                                <h4 class="font-bold text-slate-900 mb-2">Statistical Refinement</h4>
                                <p class="text-xs text-slate-500 leading-relaxed">Systems use Model Output Statistics (MOS) to correct bias‚Äîlearning if local topography causes a site to be sunnier than regional NWP models suggest.</p>
                            </div>
                            <div class="concept-card">
                                <h4 class="font-bold text-slate-900 mb-2">Sky Imagers & Optical Flow</h4>
                                <p class="text-xs text-slate-500 leading-relaxed">For intra-hour "Next 15 Minutes," local cameras analyze cloud vectors. For 24h horizons, we transition to satellite Cloud Motion Vectors (CMV).</p>
                            </div>
                            <div class="concept-card">
                                <h4 class="font-bold text-slate-900 mb-2">The Soiling Factor</h4>
                                <p class="text-xs text-slate-500 leading-relaxed">Includes a "soiling loss" variable, using local humidity and dust sensors to predict degradation before the next scheduled rain or cleaning.</p>
                            </div>
                        </div>
                    </section>

                    <!-- 2. Wind Power Forecasting -->
                    <section>
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-lg">2</div>
                            <h3 class="text-2xl font-bold text-slate-800">Wind Power Forecasting: Navigating Non-Linearity</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <p class="text-sm text-slate-600 mb-4">Wind is notoriously difficult because of the <b>Cubic Relationship</b>: power is proportional to the cube of wind speed. A 10% error in speed prediction can lead to a 30% error in power.</p>
                                <div class="formula-box text-center uppercase tracking-wider">Wind Power = 0.5 √ó Air Density √ó Area √ó Wind Speed¬≥ √ó Efficiency</div>
                            </div>
                            <div class="space-y-4">
                                <div class="p-4 bg-slate-50 rounded-xl border">
                                    <h4 class="font-bold text-xs uppercase text-slate-400 mb-1">Ramp Event Detection</h4>
                                    <p class="text-xs text-slate-600">Uses <b>Ensemble Forecasting</b> (20‚Äì50 simulations) to predict sudden, violent shifts in wind speed.</p>
                                </div>
                                <div class="p-4 bg-slate-50 rounded-xl border">
                                    <h4 class="font-bold text-xs uppercase text-slate-400 mb-1">Wake Effect Modeling</h4>
                                    <p class="text-xs text-slate-600">Accounts for turbulence where front turbines "steal" wind from those behind them as directions shift.</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 3. Load (Demand) Forecasting -->
                    <section>
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-lg bg-rose-100 text-rose-600 flex items-center justify-center font-bold text-lg">3</div>
                            <h3 class="text-2xl font-bold text-slate-800">Load Forecasting: The Human Element</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                            <div class="space-y-6">
                                <div>
                                    <h4 class="font-bold text-slate-900 mb-2">Feature Engineering</h4>
                                    <p class="text-sm text-slate-500">Goes beyond "Monday vs Sunday." We track <b>Recency Effects</b> (thermal mass from previous hot days) and <b>Calendar Events</b> (school holidays, sports).</p>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-900 mb-2">BTM Solar Disaggregation</h4>
                                    <p class="text-sm text-slate-500">Calculates how much of a load drop is due to customer solar vs. people actually leaving the building.</p>
                                </div>
                            </div>
                            <div class="bg-slate-900 text-white p-8 rounded-3xl shadow-xl">
                                <h4 class="text-emerald-400 font-bold mb-4 uppercase tracking-widest text-xs">The Intelligence Layer</h4>
                                <h5 class="text-xl font-bold mb-4">LSTM (Long Short-Term Memory)</h5>
                                <p class="text-sm text-slate-400 leading-relaxed mb-6">Unlike standard neural networks, LSTMs maintain "memory" of previous hours' trends, allowing the system to identify subtle behavioral patterns that precede consumption spikes.</p>
                                <div class="flex gap-2">
                                    <span class="px-2 py-1 bg-slate-800 rounded text-[10px] font-bold">RECURRENT NN</span>
                                    <span class="px-2 py-1 bg-slate-800 rounded text-[10px] font-bold">TIME-SERIES</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 4. The Control Hierarchy -->
                    <section class="border-t pt-16">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-lg bg-violet-100 text-violet-600 flex items-center justify-center font-bold text-lg">4</div>
                            <h3 class="text-2xl font-bold text-slate-800">The Control Hierarchy: Three Levels of Logic</h3>
                        </div>
                        <p class="text-slate-600 mb-8 leading-relaxed">To ensure both economic efficiency and electrical survival, the decision-making is split into three layers:</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                            <div class="control-layer">
                                <h4 class="font-bold text-slate-900 mb-1">Tertiary Control</h4>
                                <span class="text-[10px] font-bold text-violet-600 uppercase">The Economic Brain (EMS)</span>
                                <p class="text-xs text-slate-500 mt-2">Looks hours ahead. Sets the "Schedule."</p>
                                <p class="text-xs text-slate-700 italic mt-2">"Charge to 90% at 2 PM solar peak; discharge at 6 PM peak prices."</p>
                            </div>
                            <div class="control-layer">
                                <h4 class="font-bold text-slate-900 mb-1">Secondary Control</h4>
                                <span class="text-[10px] font-bold text-blue-600 uppercase">The Balancing Brain</span>
                                <p class="text-xs text-slate-500 mt-2">Reacts in seconds to forecasting errors or cloud transients.</p>
                                <p class="text-xs text-slate-700 italic mt-2">"Solar dropped unexpectedly; discharge battery NOW to keep frequency stable."</p>
                            </div>
                            <div class="control-layer">
                                <h4 class="font-bold text-slate-900 mb-1">Primary Control</h4>
                                <span class="text-[10px] font-bold text-emerald-600 uppercase">The Survival Brain (Inverter)</span>
                                <p class="text-xs text-slate-500 mt-2">Droop Control. Millisecond reaction to electrical physics.</p>
                                <p class="text-xs text-slate-700 italic mt-2">"Voltage dropping too fast‚Äîpush power out or system will crash."</p>
                            </div>
                        </div>

                        <div class="bg-slate-50 border p-8 rounded-3xl">
                            <h4 class="text-slate-900 font-bold mb-4 uppercase tracking-widest text-xs">The Core Logic: The Optimization Engine</h4>
                            <p class="text-sm text-slate-600 mb-4 leading-relaxed">
                                The EMS uses <b>Mixed-Integer Linear Programming (MILP)</b> to solve a massive multi-variable equation every few minutes. It evaluates four key data vectors:
                            </p>
                            <ul class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
                                <li class="flex gap-3 items-start"><span class="w-1.5 h-1.5 rounded-full bg-slate-400 mt-1.5"></span> <div><b>Forecasting:</b> Is a storm coming? <br>If yes, keep the battery full.</div></li>
                                <li class="flex gap-3 items-start"><span class="w-1.5 h-1.5 rounded-full bg-slate-400 mt-1.5"></span> <div><b>Physics:</b> Is the battery too hot? <br>If yes, limit discharge.</div></li>
                                <li class="flex gap-3 items-start"><span class="w-1.5 h-1.5 rounded-full bg-slate-400 mt-1.5"></span> <div><b>Market Data:</b> Is electricity expensive right now? <br>If yes, discharge.</div></li>
                                <li class="flex gap-3 items-start"><span class="w-1.5 h-1.5 rounded-full bg-slate-400 mt-1.5"></span> <div><b>Load Demand:</b> Is heavy machinery starting? <br>If yes, discharge.</div></li>
                            </ul>
                        </div>
                    </section>

                    <!-- 5. The Optimization Loop -->
                    <section class="border-t pt-16">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center font-bold text-lg">5</div>
                            <h3 class="text-2xl font-bold text-slate-800">The Optimization Loop: How It Decides</h3>
                        </div>
                        <p class="text-slate-600 mb-8 leading-relaxed">Forecasts are fed into a Microgrid Controller performing <b>Economic Dispatch</b> via <b>Model Predictive Control (MPC)</b>. The goal is to minimize a "Cost Function":</p>
                        
                        <div class="bg-slate-900 rounded-3xl p-8 text-white mb-10">
                            <h4 class="text-emerald-400 font-bold mb-4 uppercase tracking-widest text-xs">The Objective Function</h4>
                            <p class="text-lg text-slate-200 mb-6 font-semibold text-center py-4">Total Cost = Fuel Cost + Grid Power Cost + Battery Wear Penalty</p>
                            <p class="text-sm text-slate-300 leading-relaxed">
                                <b>Logic Example:</b> If the <b>Battery Wear Penalty</b> (degradation cost) is ‚Çπ12.50/kWh, and the <b>Grid Power Cost</b> is ‚Çπ16.60/kWh, the engine will decide to discharge. If the grid price drops to ‚Çπ4.15/kWh, the engine stops discharging and starts charging from the grid instead.
                            </p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                            <div class="p-6 bg-emerald-50 rounded-2xl border border-emerald-100">
                                <h4 class="font-bold text-emerald-800 mb-2">Multi-Objective Optimization</h4>
                                <p class="text-xs text-emerald-700 leading-relaxed">The controller assigns a "dollar per % of health" value to degradation. It switches sources based on the intersection of physical health costs and market pricing.</p>
                            </div>
                            <div class="p-6 bg-slate-50 rounded-2xl border border-slate-200">
                                <h4 class="font-bold text-slate-800 mb-2">Rolling Horizon</h4>
                                <p class="text-xs text-slate-600 leading-relaxed">The system re-forecasts every 15 minutes. It constantly shifts between binary decisions (Gen ON/OFF) and continuous power flow variables.</p>
                            </div>
                        </div>
                    </section>

                    <!-- 6. Advanced Component Physics -->
                    <section class="border-t pt-16">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-lg">6</div>
                            <div>
                                <h3 class="text-2xl font-bold text-slate-800">Advanced Component Physics</h3>
                                <h4 class="text-sm font-medium text-slate-500 italic mt-1">
                                    Modeling internal stress, thermal inertia, and switching losses.
                                </h4>
                            </div>
                        </div>
                        
                        <div class="space-y-12 mt-10">
                            <!-- Battery Degradation -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-10 items-start">
                                <div>
                                    <div class="flex items-center gap-2 mb-4">
                                        <span class="physics-tag">Electro-Chemistry</span>
                                        <h5 class="font-bold text-slate-900">Battery Aging & Stress Dynamics</h5>
                                    </div>
                                    <p class="text-sm text-slate-600 leading-relaxed mb-4">
                                        Heti uses <b>Equivalent Circuit Models (ECM)</b> to simulate the battery's "pulse." Degradation is modeled through <b>SEI (Solid Electrolyte Interphase) Layer Growth</b>‚Äîhigh temperatures and extreme SoC levels permanently trap lithium ions in the anode crust.
                                    </p>
                                    <div class="p-4 bg-slate-50 rounded-xl border-l-4 border-slate-400">
                                        <p class="text-[11px] text-slate-500 font-mono"><b>State of Health (SoH):</b> Tracked via Extended Kalman Filters (EKF) comparing predicted vs. measured voltage.</p>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div class="p-4 border rounded-xl bg-white shadow-sm">
                                        <h6 class="text-[10px] font-bold text-indigo-600 uppercase">The Temperature-C-Rate Nexus</h6>
                                        <p class="text-xs text-slate-700 mt-1">Discharging at 2C creates exponential internal heat (Heat loss = I^2 R), accelerating chemical breakdown.</p>
                                    </div>
                                    <div class="p-4 border rounded-xl bg-white shadow-sm">
                                        <h6 class="text-[10px] font-bold text-indigo-600 uppercase">Ion Diffusion Limits</h6>
                                        <p class="text-xs text-slate-700 mt-1">C-Rate limiting prevents "dumping" power too fast when internal resistance is high (e.g., cold batteries).</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Diesel Fuel Curves -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-10 items-start border-t pt-10">
                                <div>
                                    <div class="flex items-center gap-2 mb-4">
                                        <span class="physics-tag">Thermodynamics</span>
                                        <h5 class="font-bold text-slate-900">Diesel Transient Physics</h5>
                                    </div>
                                    <p class="text-sm text-slate-600 leading-relaxed mb-4">
                                        Beyond the quadratic <b>BSFC fuel curve</b> (P = aP^2 + bP + c), Heti models <b>Thermal Inertia</b>. Cold starts consume 15% more fuel until the engine block reaches optimal thermal equilibrium (~85¬∞C).
                                    </p>
                                    <div class="p-4 bg-amber-50 rounded-xl border border-amber-100">
                                        <p class="text-[11px] text-amber-800"><b>Spinning Reserves:</b> Maintains specific RPM to provide "virtual inertia" to counter solar drop-offs (clouds).</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="flex gap-4">
                                        <div class="flex-1 p-4 bg-slate-50 rounded-xl border">
                                            <h6 class="text-[10px] font-bold text-slate-500 uppercase">Minimum Run Time</h6>
                                            <p class="text-xs text-slate-600 mt-1">Prevents mechanical wear from short-cycling.</p>
                                        </div>
                                        <div class="flex-1 p-4 bg-slate-50 rounded-xl border">
                                            <h6 class="text-[10px] font-bold text-slate-500 uppercase">Wet Stacking</h6>
                                            <p class="text-xs text-slate-600 mt-1">Low-load protection for exhaust health.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Inverter Efficiencies -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-10 items-start border-t pt-10">
                                <div>
                                    <div class="flex items-center gap-2 mb-4">
                                        <span class="physics-tag">Power Electronics</span>
                                        <h5 class="font-bold text-slate-900">Three-Part Loss Mapping</h5>
                                    </div>
                                    <p class="text-sm text-slate-600 leading-relaxed">
                                        Inverter efficiency is not a single number but a map of <b>Switching Losses</b> (constant frequency flips), <b>Ohmic Losses</b> (I^2R), and <b>Magnetic Losses</b> (core eddy currents).
                                    </p>
                                </div>
                                <div class="space-y-4">
                                    <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                                        <h6 class="text-[10px] font-bold text-blue-600 uppercase">Clipping Physics</h6>
                                        <p class="text-xs text-blue-800">When DC input exceeds AC rating, "lost" energy manifests as localized heat on the DC bus.</p>
                                    </div>
                                    <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                                        <h6 class="text-[10px] font-bold text-blue-600 uppercase">Reactive Support</h6>
                                        <p class="text-xs text-blue-800">Sacrifices real power (Watts) to provide VARs for grid voltage stability.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Summary Table -->
                            <div class="border rounded-2xl overflow-hidden shadow-sm">
                                <table class="w-full bg-white">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th>Component</th>
                                            <th>Physics Variable</th>
                                            <th>Practical Constraint</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        <tr>
                                            <td class="font-bold">Battery</td>
                                            <td>Ion Diffusion / Resistance</td>
                                            <td>C-Rate Limiting: Prevents damage when cold/aged.</td>
                                        </tr>
                                        <tr>
                                            <td class="font-bold">Diesel</td>
                                            <td>Thermal Equilibrium</td>
                                            <td>Spinning Reserve: Maintains inertia for stability.</td>
                                        </tr>
                                        <tr>
                                            <td class="font-bold">Inverter</td>
                                            <td>Junction Temperature</td>
                                            <td>Efficiency Mapping: Optimizes power electronic lifespan.</td>
                                        </tr>
                                        <tr>
                                            <td class="font-bold">System</td>
                                            <td>Kirchhoff's Laws</td>
                                            <td>Power Balance: Gen + Storage Discharge = Load + Losses.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- GLOSSARY SECTION -->
                    <section class="border-t pt-16">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-lg bg-slate-100 text-slate-600 flex items-center justify-center font-bold text-lg">
                                <i class="fa-solid fa-book"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-800">Technical Glossary</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6">
                            <div>
                                <div class="glossary-term">MILP (Mixed-Integer Linear Programming)</div>
                                <div class="glossary-def">An optimization method that handles both continuous variables (like power flow) and binary decisions (like generator on/off states) to find the most cost-effective solution.</div>
                            </div>
                            <div>
                                <div class="glossary-term">LSTM (Long Short-Term Memory)</div>
                                <div class="glossary-def">A type of recurrent neural network that can learn patterns over time, essential for predicting load based on historical consumption trends.</div>
                            </div>
                            <div>
                                <div class="glossary-term">MOS (Model Output Statistics)</div>
                                <div class="glossary-def">Statistical techniques that correct systematic errors in weather forecasts by learning from historical prediction vs. actual data at specific locations.</div>
                            </div>
                            <div>
                                <div class="glossary-term">MPC (Model Predictive Control)</div>
                                <div class="glossary-def">A control strategy that optimizes current decisions while considering future predictions over a "rolling horizon" that updates continuously.</div>
                            </div>
                            <div>
                                <div class="glossary-term">EMS (Energy Management System)</div>
                                <div class="glossary-def">The tertiary control layer that makes economic decisions hours ahead, scheduling when to charge/discharge based on price forecasts.</div>
                            </div>
                            <div>
                                <div class="glossary-term">SoC (State of Charge)</div>
                                <div class="glossary-def">The current energy level of a battery expressed as a percentage of total capacity (0-100%).</div>
                            </div>
                            <div>
                                <div class="glossary-term">SoH (State of Health)</div>
                                <div class="glossary-def">A measure of battery degradation, comparing current maximum capacity to the original rated capacity when new.</div>
                            </div>
                            <div>
                                <div class="glossary-term">C-Rate</div>
                                <div class="glossary-def">The rate at which a battery charges or discharges relative to its capacity. A 1C rate means fully charging/discharging in 1 hour.</div>
                            </div>
                            <div>
                                <div class="glossary-term">SEI Layer (Solid Electrolyte Interphase)</div>
                                <div class="glossary-def">A protective film that forms on battery anodes. Over time it grows thicker, trapping lithium ions and reducing battery capacity.</div>
                            </div>
                            <div>
                                <div class="glossary-term">BSFC (Brake Specific Fuel Consumption)</div>
                                <div class="glossary-def">A measure of diesel generator efficiency, expressed as fuel consumed per unit of power output (typically g/kWh).</div>
                            </div>
                            <div>
                                <div class="glossary-term">Droop Control</div>
                                <div class="glossary-def">A primary control method where power output automatically adjusts in response to frequency/voltage changes, providing grid stability in milliseconds.</div>
                            </div>
                            <div>
                                <div class="glossary-term">BTM (Behind-The-Meter)</div>
                                <div class="glossary-def">Energy resources located on the customer's side of the utility meter, like rooftop solar or on-site batteries.</div>
                            </div>
                        </div>
                        <div class="mt-8 p-6 bg-slate-50 rounded-xl border">
                            <h4 class="font-bold text-slate-900 mb-2 text-sm">References & Further Reading</h4>
                            <ul class="text-xs text-slate-600 space-y-1 list-disc list-inside">
                                <li>IEEE Standards for Microgrid Controllers (IEEE 2030.7-2017)</li>
                                <li>NREL - Solar Forecasting Best Practices (Technical Report)</li>
                                <li>Battery degradation models: Ecker et al. (2012) - Journal of Power Sources</li>
                                <li>Wind power forecasting: Giebel et al. - State-of-the-art on methods and applications</li>
                            </ul>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <!-- SECTION: SIMULATION -->
        <div id="section-simulation" class="hidden-section flex h-full" role="tabpanel" aria-labelledby="tab-simulation">
            <aside id="mobile-sidebar" class="w-80 bg-white border-r flex flex-col overflow-hidden">
                <div class="sidebar-content p-6 space-y-6 overflow-y-auto custom-scroll">
                <div class="border-b pb-6">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Environment Parameters</h2>
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between text-xs font-medium mb-2">
                                <span class="tooltip-container">
                                    Solar Intensity
                                    <i class="fa-solid fa-circle-info tooltip-icon"></i>
                                    <span class="tooltip-text">Peak solar irradiance as a percentage of maximum capacity. Higher values simulate sunny conditions.</span>
                                </span>
                                <span id="v-sol" class="text-amber-500 font-bold">60%</span>
                            </div>
                            <div class="slider-wrap">
                                <div class="slider-track solar"></div>
                                <div class="slider-fill" id="fill-sol"></div>
                                <input type="range" id="s-sol" class="w-full" min="0" max="100" value="60" aria-label="Solar Intensity percentage">
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs font-medium mb-2">
                                <span class="tooltip-container">
                                    Wind Magnitude
                                    <i class="fa-solid fa-circle-info tooltip-icon"></i>
                                    <span class="tooltip-text">Average wind power output as a percentage. Wind power varies throughout the day based on typical patterns.</span>
                                </span>
                                <span id="v-wnd" class="text-blue-400 font-bold">30%</span>
                            </div>
                            <div class="slider-wrap">
                                <div class="slider-track wind"></div>
                                <div class="slider-fill" id="fill-wnd"></div>
                                <input type="range" id="s-wnd" class="w-full" min="0" max="100" value="30" aria-label="Wind Magnitude percentage">
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs font-medium mb-2">
                                <span class="tooltip-container">
                                    Base Load Demand
                                    <i class="fa-solid fa-circle-info tooltip-icon"></i>
                                    <span class="tooltip-text">Baseline building energy consumption. Actual load varies with time-of-day patterns (peaks morning and evening).</span>
                                </span>
                                <span id="v-lod" class="text-rose-500 font-bold">50 kW</span>
                            </div>
                            <div class="slider-wrap">
                                <div class="slider-track load"></div>
                                <div class="slider-fill" id="fill-lod"></div>
                                <input type="range" id="s-lod" class="w-full" min="10" max="150" value="50" aria-label="Base Load Demand in kilowatts">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-6 custom-scroll space-y-8">
                    <div>
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Hardware Config</h2>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-xs font-medium mb-2">
                                    <span class="tooltip-container">
                                        Battery Capacity
                                        <i class="fa-solid fa-circle-info tooltip-icon"></i>
                                        <span class="tooltip-text">Total energy storage capacity. Larger batteries allow more energy arbitrage and backup power duration.</span>
                                    </span>
                                    <span id="v-bat" class="text-emerald-500 font-bold">200 kWh</span>
                                </div>
                                <div class="slider-wrap">
                                    <div class="slider-track battery"></div>
                                    <div class="slider-fill" id="fill-bat"></div>
                                    <input type="range" id="s-bat" class="w-full" min="50" max="1000" value="200" aria-label="Battery Capacity in kilowatt-hours">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Preset Scenarios</h2>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <button class="preset-btn" onclick="applyPreset('sunny')">
                                <i class="fa-solid fa-sun text-amber-500"></i> Sunny Day
                            </button>
                            <button class="preset-btn" onclick="applyPreset('cloudy')">
                                <i class="fa-solid fa-cloud text-slate-400"></i> Cloudy
                            </button>
                            <button class="preset-btn" onclick="applyPreset('highdemand')">
                                <i class="fa-solid fa-bolt text-rose-500"></i> High Demand
                            </button>
                            <button class="preset-btn" onclick="applyPreset('night')">
                                <i class="fa-solid fa-moon text-indigo-400"></i> Night
                            </button>
                        </div>
                    </div>

                    <div class="pt-4 space-y-2">
                        <button id="btn-grid" class="w-full py-3 rounded-xl bg-black text-white text-xs font-bold uppercase tracking-widest hover:bg-slate-800 transition" aria-label="Toggle Power Grid connection on or off">Toggle Power Grid</button>
                        <button id="btn-storm" class="w-full py-3 rounded-xl bg-slate-800 text-white text-xs font-bold uppercase tracking-widest hover:bg-slate-900 transition" aria-label="Simulate a storm scenario">Simulate Storm</button>
                        <button id="btn-reset" class="w-full py-3 rounded-xl border border-rose-200 text-rose-600 text-xs font-bold uppercase tracking-widest hover:bg-rose-50 transition" aria-label="Reset all parameters to factory defaults">Factory Reset</button>
                    </div>
                </div>
                </div>
            </aside>

            <!-- Main Display Area -->
            <section class="flex-1 flex flex-col overflow-y-auto overflow-x-hidden custom-scroll mobile-main-content">
                <div class="p-6 flex flex-col gap-6">
                    <!-- Welcome Banner -->
                    <div class="welcome-banner" id="welcome-banner">
                        <h3><span id="goal-emoji">üí∞</span> <span id="goal-title">Optimizing for Cost Savings</span></h3>
                        <p id="goal-description">Try adjusting the sliders or selecting a preset scenario to see how different conditions affect your savings!</p>
                    </div>
                    
                    <div class="bg-white border-2 border-slate-200 rounded-2xl p-6 shadow-sm mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 stats-grid-mobile">
                            <div class="p-5 rounded-xl bg-slate-50 stat-card stat-card-mobile">
                                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Operational Cost</p>
                                <p id="stat-cost" class="text-2xl font-bold">‚Çπ0.00</p>
                                <div id="zone-cost" class="zone-badge optimal"><span class="zone-dot"></span>Optimal</div>
                            </div>
                            <div class="p-5 rounded-xl bg-slate-50 stat-card stat-card-mobile">
                                <p class="text-[10px] font-bold text-rose-600 uppercase tracking-widest mb-1">Baseline Comparison</p>
                                <p id="stat-baseline" class="text-2xl font-bold text-rose-600">‚Çπ0.00</p>
                                <div id="zone-baseline" class="zone-badge optimal"><span class="zone-dot"></span>Optimal</div>
                            </div>
                            <div class="p-5 rounded-xl bg-emerald-50 stat-card stat-card-mobile border-2 border-emerald-200">
                                <p class="text-[10px] font-bold text-emerald-700 uppercase tracking-widest mb-1">Total Savings</p>
                                <p id="stat-savings" class="text-2xl font-bold text-emerald-600">‚Çπ0.00</p>
                                <div id="zone-savings" class="zone-badge optimal"><span class="zone-dot"></span>Optimal</div>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Settings Toggle Button -->
                    <button class="mobile-toggle-btn" onclick="toggleMobileSidebar()">
                        <span>‚öôÔ∏è Adjust Parameters</span>
                        <span class="mobile-toggle-icon">‚ñº</span>
                    </button>

                    <div class="grid grid-cols-1 gap-6">
                        <div class="h-[500px] chart-container-mobile p-8 rounded-2xl flex flex-col border-4 border-slate-800 bg-white shadow-lg">
                            <div class="flex justify-between items-center mb-4 shrink-0">
                                <h3 class="text-sm font-bold">Power Dispatch Profile (24h)</h3>
                                <div class="flex gap-4 text-[10px] font-bold">
                                    <span class="flex items-center gap-1"><i class="fa-solid fa-circle text-amber-500"></i> SOLAR</span>
                                    <span class="flex items-center gap-1"><i class="fa-solid fa-circle text-rose-500"></i> LOAD</span>
                                    <span class="flex items-center gap-1"><i class="fa-solid fa-square text-blue-400"></i> GRID</span>
                                </div>
                            </div>
                            <div class="flex-1 min-h-0 relative">
                                <canvas id="pwrChart"></canvas>
                            </div>
                        </div>

                        <div class="h-[500px] chart-container-mobile p-8 rounded-2xl flex flex-col border-4 border-slate-800 bg-white shadow-lg">
                            <div class="flex justify-between items-center mb-4 shrink-0">
                                <h3 class="text-sm font-bold">Battery State of Charge (%)</h3>
                                <div class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded">STORAGE CAPACITY MONITOR</div>
                            </div>
                            <div class="flex-1 min-h-0 relative">
                                <canvas id="socChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- OPTIMIZATION STRATEGY SUMMARY -->
                    <div class="mt-6">
                        <div class="glass-panel p-8 rounded-2xl">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">Integration Strategy: Two-Stage Optimization</h2>
                        <p class="text-slate-600">The most effective strategy uses a "nested" approach: Day-Ahead Planning (for long-term cost) and Real-Time Rescheduling (for immediate physics).</p>
                    </div>

                    <div class="grid grid-cols-1 gap-6 mb-10">
                        <div class="bg-white p-6 rounded-xl border-l-4 border-l-violet-500">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 rounded-lg bg-violet-100 text-violet-600 flex items-center justify-center font-bold">1</div>
                                <h3 class="text-lg font-bold text-slate-900">Day-Ahead "Economic Dispatch"</h3>
                            </div>
                            <p class="text-sm text-slate-600 mb-4">Every night (e.g., at 00:00), the system runs an optimization for the next 24 hours based on forecasts.</p>
                            <div class="space-y-2">
                                <div class="flex gap-2 items-start">
                                    <span class="text-violet-600 font-bold">‚Ä¢</span>
                                    <p class="text-xs text-slate-700"><b>Goal:</b> Determine the "on/off" status of the diesel generator and the ideal battery State of Charge (SoC).</p>
                                </div>
                                <div class="flex gap-2 items-start">
                                    <span class="text-violet-600 font-bold">‚Ä¢</span>
                                    <p class="text-xs text-slate-700"><b>Logic:</b> It looks for the cheapest time to charge the battery (either from excess solar or low-price grid electricity) and the best time to discharge it to avoid "peak pricing" or high-load events.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl border-l-4 border-l-blue-500">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center font-bold">2</div>
                                <h3 class="text-lg font-bold text-slate-900">Real-Time "Receding Horizon"</h3>
                            </div>
                            <p class="text-sm text-slate-600 mb-4">Every 15 minutes, the system re-evaluates. If a cloud passes (solar drop) or a machine starts up (load spike), the system adjusts the stage 1 plan without violating the long-term battery health constraints.</p>
                        </div>
                    </div>

                    <!-- Mathematical Objective Function -->
                    <div class="bg-slate-900 text-white p-8 rounded-2xl mb-10">
                        <h3 class="text-xl font-bold mb-4 text-emerald-400">Mathematical Objective Function</h3>
                        <p class="text-sm text-slate-300 mb-6">The controller uses a Mixed-Integer Linear Programming (MILP) model to solve the following cost equation for every hour (t):</p>
                        <div class="bg-slate-800 p-6 rounded-xl mb-6 overflow-x-auto">
                            <div class="font-mono text-sm text-center whitespace-nowrap">
                                J = min Œ£<sub>t=1‚Üí24</sub> [C<sub>grid</sub>(t) ¬∑ P<sub>grid</sub>(t)] + [C<sub>fuel</sub> ¬∑ F(P<sub>gen,t</sub>)] + [C<sub>deg</sub> ¬∑ |P<sub>bat,t</sub>|]
                            </div>
                        </div>
                        <div class="space-y-4 text-xs">
                            <div class="bg-slate-800 p-4 rounded-lg">
                                <div class="font-bold text-blue-400 mb-1">Grid Cost (C<sub>grid</sub>)</div>
                                <div class="text-slate-400">Fluctuates based on Time-of-Use (ToU) rates.</div>
                            </div>
                            <div class="bg-slate-800 p-4 rounded-lg">
                                <div class="font-bold text-amber-400 mb-1">Battery Cost (C<sub>deg</sub>)</div>
                                <div class="text-slate-400">A "hidden" cost assigned to every kWh moved through the battery to account for degradation.</div>
                            </div>
                            <div class="bg-slate-800 p-4 rounded-lg">
                                <div class="font-bold text-rose-400 mb-1">Fuel Curve (F)</div>
                                <div class="text-slate-400">Non-linear cost that ensures the generator stays in the 60‚Äì80% efficiency "sweet spot."</div>
                            </div>
                        </div>
                    </div>

                    <!-- Hourly Execution Playbook -->
                    <div class="mb-10">
                        <h3 class="text-xl font-bold text-slate-900 mb-6">The Hourly Execution Playbook</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full bg-white rounded-xl overflow-hidden shadow-sm">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="text-left p-4 font-bold text-xs uppercase text-slate-600">Time Block</th>
                                        <th class="text-left p-4 font-bold text-xs uppercase text-slate-600">Strategy Phase</th>
                                        <th class="text-left p-4 font-bold text-xs uppercase text-slate-600">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <tr>
                                        <td class="p-4 font-mono text-sm font-bold">00:00 ‚Äì 05:00</td>
                                        <td class="p-4"><span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold">Pre-Charging</span></td>
                                        <td class="p-4 text-sm text-slate-600">If grid prices are low, charge the battery to 80%. Keep the generator OFF.</td>
                                    </tr>
                                    <tr>
                                        <td class="p-4 font-mono text-sm font-bold">06:00 ‚Äì 09:00</td>
                                        <td class="p-4"><span class="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-bold">Peak Shaving</span></td>
                                        <td class="p-4 text-sm text-slate-600">As the morning load spikes, discharge the battery to prevent "Demand Charges" from the grid.</td>
                                    </tr>
                                    <tr>
                                        <td class="p-4 font-mono text-sm font-bold">10:00 ‚Äì 15:00</td>
                                        <td class="p-4"><span class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold">Solar Arbitrage</span></td>
                                        <td class="p-4 text-sm text-slate-600">Use solar to power the load. Divert all excess solar to the battery until it reaches 95%.</td>
                                    </tr>
                                    <tr>
                                        <td class="p-4 font-mono text-sm font-bold">16:00 ‚Äì 20:00</td>
                                        <td class="p-4"><span class="px-3 py-1 bg-rose-100 text-rose-700 rounded-full text-xs font-bold">Load Leveling</span></td>
                                        <td class="p-4 text-sm text-slate-600">Grid prices are highest now. Force the battery to carry the majority of the load.</td>
                                    </tr>
                                    <tr>
                                        <td class="p-4 font-mono text-sm font-bold">21:00 ‚Äì 23:00</td>
                                        <td class="p-4"><span class="px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-xs font-bold">Recovery</span></td>
                                        <td class="p-4 text-sm text-slate-600">Allow the battery to rest. If SoC is critically low, run the generator at its peak efficiency to recharge the battery for tomorrow.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Operational Constraints -->
                    <div class="bg-gradient-to-br from-slate-50 to-blue-50 p-8 rounded-2xl mb-10">
                        <h3 class="text-xl font-bold text-slate-900 mb-4">Key Operational Constraints (The "Guardrails")</h3>
                        <p class="text-sm text-slate-600 mb-6">The scheduling strategy is only valid if it respects the physical limits of the system:</p>
                        <div class="space-y-4">
                            <div class="flex gap-4 items-start bg-white p-4 rounded-lg shadow-sm">
                                <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center font-bold text-sm shrink-0">‚ö°</div>
                                <div>
                                    <div class="font-bold text-slate-900 mb-1">Power Balance</div>
                                    <div class="text-sm text-slate-600 font-mono">P<sub>solar</sub>(t) + P<sub>wind</sub>(t) + P<sub>bat,discharge</sub>(t) + P<sub>gen</sub>(t) = P<sub>load</sub>(t) + P<sub>losses</sub>(t)</div>
                                </div>
                            </div>
                            <div class="flex gap-4 items-start bg-white p-4 rounded-lg shadow-sm">
                                <div class="w-8 h-8 rounded-full bg-rose-100 text-rose-600 flex items-center justify-center font-bold text-sm shrink-0">üîã</div>
                                <div>
                                    <div class="font-bold text-slate-900 mb-1">Battery Floor</div>
                                    <div class="text-sm text-slate-600">Never let the SoC drop below 20% to prevent chemical "starvation."</div>
                                </div>
                            </div>
                            <div class="flex gap-4 items-start bg-white p-4 rounded-lg shadow-sm">
                                <div class="w-8 h-8 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center font-bold text-sm shrink-0">‚öôÔ∏è</div>
                                <div>
                                    <div class="font-bold text-slate-900 mb-1">Generator Min-Run</div>
                                    <div class="text-sm text-slate-600">If the diesel generator is started, it must run for at least 60 minutes to prevent mechanical "wet-stacking."</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary of Benefits -->
                    <div class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white p-8 rounded-2xl">
                        <h3 class="text-2xl font-bold mb-4">Summary of Benefits</h3>
                        <p class="text-emerald-50 mb-6">By using this predictive strategy instead of a simple "rule-based" (if-then) approach, microgrids typically see:</p>
                        <div class="space-y-4">
                            <div class="bg-white/10 backdrop-blur-sm p-6 rounded-xl">
                                <div class="text-4xl font-bold mb-2">15‚Äì25%</div>
                                <div class="text-emerald-50 text-sm">Reduction in total electricity costs</div>
                            </div>
                            <div class="bg-white/10 backdrop-blur-sm p-6 rounded-xl">
                                <div class="text-4xl font-bold mb-2">30%</div>
                                <div class="text-emerald-50 text-sm">Increase in battery cycle life</div>
                            </div>
                            <div class="bg-white/10 backdrop-blur-sm p-6 rounded-xl">
                                <div class="text-4xl font-bold mb-2">‚ÜìCO‚ÇÇ</div>
                                <div class="text-emerald-50 text-sm">Significant reduction in carbon footprint by maximizing renewable "self-consumption"</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        let gridActive = true;
        let pChart, sChart;

        // Show export button when on simulation tab
        function switchTab(tab) {
            const simSection = document.getElementById('section-simulation');
            const conSection = document.getElementById('section-concept');
            const tabSim = document.getElementById('tab-simulation');
            const tabCon = document.getElementById('tab-concept');
            const exportBtn = document.getElementById('btn-export');

            if (tab === 'simulation') {
                simSection.classList.remove('hidden-section');
                conSection.classList.add('hidden-section');
                tabSim.classList.add('tab-active');
                tabSim.classList.remove('text-gray-400');
                tabSim.setAttribute('aria-selected', 'true');
                tabCon.classList.remove('tab-active');
                tabCon.classList.add('text-gray-400');
                tabCon.setAttribute('aria-selected', 'false');
                exportBtn.classList.remove('hidden');
                if (pChart) pChart.resize();
                if (sChart) sChart.resize();
                
                // Show mobile popup on first visit to simulation tab
                if (window.innerWidth <= 768) {
                    showMobilePrefPopup();
                }
            } else {
                simSection.classList.add('hidden-section');
                conSection.classList.remove('hidden-section');
                tabCon.classList.add('tab-active');
                tabCon.classList.remove('text-gray-400');
                tabCon.setAttribute('aria-selected', 'true');
                tabSim.classList.remove('tab-active');
                tabSim.classList.add('text-gray-400');
                tabSim.setAttribute('aria-selected', 'false');
                exportBtn.classList.add('hidden');
            }
        }
        
        // ‚îÄ‚îÄ‚îÄ Mobile Preferences Popup ‚îÄ‚îÄ‚îÄ
        let _prefPopupShown = false;            // track within session
        function showMobilePrefPopup() {
            if (_prefPopupShown) return;         // only once per session
            _prefPopupShown = true;
            const popup = document.getElementById('mobile-pref-popup');
            setTimeout(() => popup.classList.add('show'), 600);
            // auto-dismiss after 6 s
            setTimeout(() => popup.classList.remove('show'), 6600);
        }

        function closeMobilePrefPopup() {
            document.getElementById('mobile-pref-popup').classList.remove('show');
        }

        const inputs = {
            sol: document.getElementById('s-sol'),
            wnd: document.getElementById('s-wnd'),
            lod: document.getElementById('s-lod'),
            bat: document.getElementById('s-bat')
        };

        const view = {
            vSol: document.getElementById('v-sol'),
            vWnd: document.getElementById('v-wnd'),
            vLod: document.getElementById('v-lod'),
            vBat: document.getElementById('v-bat'),
            statCost: document.getElementById('stat-cost'),
            statBaseline: document.getElementById('stat-baseline'),
            statSavings: document.getElementById('stat-savings')
        };

        // Update slider fills to show progress (global function)
        function updateSliderFills() {
            // Solar slider (0-100)
            const solPercent = (inputs.sol.value / 100) * 100;
            const fillSol = document.getElementById('fill-sol');
            if (fillSol) fillSol.style.width = solPercent + '%';
            
            // Wind slider (0-100)
            const wndPercent = (inputs.wnd.value / 100) * 100;
            const fillWnd = document.getElementById('fill-wnd');
            if (fillWnd) fillWnd.style.width = wndPercent + '%';
            
            // Load slider (10-150)
            const lodPercent = ((inputs.lod.value - 10) / (150 - 10)) * 100;
            const fillLod = document.getElementById('fill-lod');
            if (fillLod) fillLod.style.width = lodPercent + '%';
            
            // Battery slider (50-1000)
            const batPercent = ((inputs.bat.value - 50) / (1000 - 50)) * 100;
            const fillBat = document.getElementById('fill-bat');
            if (fillBat) fillBat.style.width = batPercent + '%';
        }

        function calculateSimulation() {
            const T = Array.from({length: 24}, (_, i) => i);
            const solVal = parseFloat(inputs.sol.value);
            const wndVal = parseFloat(inputs.wnd.value);
            const lodVal = parseFloat(inputs.lod.value);
            const cap = parseFloat(inputs.bat.value);
            const pHigh = 0.35;
            const pLow = 0.12;
            const eff = 0.95;

            const solar = T.map(h => solVal * Math.exp(-Math.pow(h - 12, 2) / (2 * Math.pow(2.5, 2))));
            const wind = T.map(h => wndVal * (0.7 + 0.3 * Math.cos(h / 3)));
            const load = T.map(h => lodVal * (1 + 0.8 * Math.exp(-Math.pow(h - 19, 2) / 5) + 0.5 * Math.exp(-Math.pow(h - 8, 2) / 3)));
            
            let soc = 50.0;
            let socHist = [];
            let gridHist = [];
            let battHist = [];
            let cost = 0, baseline = 0;
            let batteryStatus = 'idle';

            for (let h = 0; h < 24; h++) {
                let isPeak = (h >= 17 && h <= 21);
                let price = isPeak ? pHigh : pLow;
                
                // CRITICAL FIX: Include wind in renewable generation
                let renewable = solar[h] + wind[h];
                let net = renewable - load[h];
                
                // Calculate baseline cost (no battery, all from grid)
                if (net < 0) baseline += Math.abs(net) * price;

                let pGrid = 0, pBatt = 0;
                
                // Battery constraints
                const socMin = cap * 0.10;  // 10% minimum
                const socMax = cap * 0.95;  // 95% maximum
                const socAvailable = soc - socMin;  // Energy available for discharge
                const socRoom = socMax - soc;       // Room available for charge
                
                if (!gridActive) {
                    // Islanded mode - use battery to balance
                    if (net > 0) {
                        // Surplus - charge battery if room available
                        pBatt = Math.min(net, socRoom);
                    } else {
                        // Deficit - discharge battery if energy available
                        pBatt = Math.max(net, -socAvailable);
                    }
                    pGrid = 0;
                } else {
                    // Grid-connected mode - optimize economically
                    if (isPeak && net < 0) {
                        // Peak hours with deficit - discharge battery if available
                        pBatt = Math.max(net, -socAvailable);
                    } else if (net > 0) {
                        // Surplus - charge battery if room available
                        pBatt = Math.min(net, socRoom);
                    } else {
                        pBatt = 0;
                    }
                    pGrid = -(net - pBatt);
                }

                // CRITICAL FIX: Apply battery efficiency and update SOC with proper limits
                let socChange = pBatt > 0 ? pBatt * eff : pBatt / eff;
                let newSoc = soc + socChange;
                
                // Enforce hard limits
                newSoc = Math.max(socMin, Math.min(socMax, newSoc));
                socChange = newSoc - soc;
                soc = newSoc;
                
                socHist.push((soc / cap) * 100);
                gridHist.push(pGrid);
                battHist.push(pBatt);
                cost += Math.max(0, pGrid) * price;
                
                // Determine battery status
                if (Math.abs(pBatt) < 0.5) batteryStatus = 'idle';
                else if (pBatt > 0) batteryStatus = 'charging';
                else batteryStatus = 'discharging';
            }
            
            return { T, solar, wind, load, gridHist, socHist, battHist, cost, baseline, batteryStatus };
        }

        function refreshSimulation() {
            const d = calculateSimulation();
            view.vSol.innerText = inputs.sol.value + "%";
            view.vWnd.innerText = inputs.wnd.value + "%";
            view.vLod.innerText = inputs.lod.value + " kW";
            view.vBat.innerText = inputs.bat.value + " kWh";
            view.statCost.innerText = `‚Çπ${d.cost.toFixed(2)}`;
            view.statBaseline.innerText = `‚Çπ${d.baseline.toFixed(2)}`;
            
            // Enable continue button during onboarding
            enableContinueButton();
            
            // CRITICAL FIX: Handle negative savings properly
            const savings = d.baseline - d.cost;
            if (savings >= 0) {
                view.statSavings.innerText = `‚Çπ${savings.toFixed(2)}`;
                view.statSavings.className = 'text-2xl font-bold text-emerald-600';
            } else {
                view.statSavings.innerText = `-‚Çπ${Math.abs(savings).toFixed(2)}`;
                view.statSavings.className = 'text-2xl font-bold text-rose-600';
            }

            // --- Zone indicators ---
            function setZone(el, zone, label) {
                el.className = 'zone-badge ' + zone;
                el.innerHTML = '<span class="zone-dot"></span>' + label;
            }
            // Cost zone: optimal < 30% of baseline, warning 30-60%, critical > 60%
            const costRatio = d.baseline > 0 ? d.cost / d.baseline : 0;
            if (costRatio <= 0.3) setZone(document.getElementById('zone-cost'), 'optimal', 'Optimal');
            else if (costRatio <= 0.6) setZone(document.getElementById('zone-cost'), 'warning', 'Warning');
            else setZone(document.getElementById('zone-cost'), 'critical', 'High');

            // Baseline zone: high baseline means heavy grid dependency
            const baselineKW = parseFloat(inputs.lod.value);
            if (baselineKW <= 60) setZone(document.getElementById('zone-baseline'), 'optimal', 'Low');
            else if (baselineKW <= 100) setZone(document.getElementById('zone-baseline'), 'warning', 'Moderate');
            else setZone(document.getElementById('zone-baseline'), 'critical', 'High');

            // Savings zone: positive = optimal, small positive = warning, negative = critical
            const sav = d.baseline - d.cost;
            if (sav >= d.baseline * 0.2) setZone(document.getElementById('zone-savings'), 'optimal', 'Optimal');
            else if (sav >= 0) setZone(document.getElementById('zone-savings'), 'warning', 'Marginal');
            else setZone(document.getElementById('zone-savings'), 'critical', 'Loss');


            // Status pill removed from UI


            pChart.data.datasets[0].data = d.solar;
            pChart.data.datasets[1].data = d.load;
            pChart.data.datasets[2].data = d.gridHist;
            pChart.update('none');

            sChart.data.datasets[0].data = d.socHist;
            sChart.update('none');
        }

        function initSimulation() {
            const ctxP = document.getElementById('pwrChart').getContext('2d');
            pChart = new Chart(ctxP, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + "h"),
                    datasets: [
                        { label: 'Solar Output', data: [], borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.4, borderWidth: 2, pointRadius: 0 },
                        { label: 'Building Load', data: [], borderColor: '#f43f5e', borderDash: [5, 5], tension: 0.4, borderWidth: 2, pointRadius: 0 },
                        { label: 'Grid Exchange', data: [], type: 'bar', backgroundColor: 'rgba(59, 130, 246, 0.4)', borderRadius: 4 }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            display: true,
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        } 
                    },
                    scales: { 
                        y: { 
                            grid: { color: '#f1f5f9' }, 
                            ticks: { font: { size: 10 } },
                            title: {
                                display: true,
                                text: 'Power (kW)',
                                font: { size: 11, weight: '600' }
                            }
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { font: { size: 10 } },
                            title: {
                                display: true,
                                text: 'Time (hours)',
                                font: { size: 11, weight: '600' }
                            }
                        }
                    } 
                }
            });

            const ctxS = document.getElementById('socChart').getContext('2d');
            sChart = new Chart(ctxS, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + "h"),
                    datasets: [{ label: 'Battery SoC', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.05)', fill: true, tension: 0.2, pointRadius: 4, pointBackgroundColor: '#10b981', borderWidth: 3 }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            display: true,
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        } 
                    },
                    scales: { 
                        y: { 
                            min: 0, 
                            max: 100, 
                            grid: { color: '#f1f5f9' }, 
                            ticks: { font: { size: 11, weight: '600' } },
                            title: {
                                display: true,
                                text: 'State of Charge (%)',
                                font: { size: 11, weight: '600' }
                            }
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { font: { size: 11 } },
                            title: {
                                display: true,
                                text: 'Time (hours)',
                                font: { size: 11, weight: '600' }
                            }
                        }
                    } 
                }
            });

            // Debounced refresh: label updates are instant, chart math waits 80ms after drag stops
            let debounceTimer = null;
            function debouncedRefresh() {
                // Instant label feedback
                view.vSol.innerText = inputs.sol.value + "%";
                view.vWnd.innerText = inputs.wnd.value + "%";
                view.vLod.innerText = inputs.lod.value + " kW";
                view.vBat.innerText = inputs.bat.value + " kWh";
                // Update slider fills
                updateSliderFills();
                // Debounce the heavy chart work
                if (debounceTimer) clearTimeout(debounceTimer);
                debounceTimer = setTimeout(refreshSimulation, 80);
            }
            Object.values(inputs).forEach(i => i.addEventListener('input', debouncedRefresh));
            document.getElementById('btn-grid').onclick = () => { 
                gridActive = !gridActive; 
                refreshSimulation(); 
                showToast(gridActive ? 'Grid connected ‚úì' : 'Grid disconnected - Islanded mode');
            };
            document.getElementById('btn-storm').onclick = () => { 
                inputs.sol.value = 5; 
                inputs.wnd.value = 85;  // CRITICAL FIX: Increase wind during storm
                gridActive = false;
                updateSliderFills();
                refreshSimulation();
                showToast('Storm scenario activated ‚ö†Ô∏è');
            };
            document.getElementById('btn-reset').onclick = () => { 
                inputs.sol.value = 60; inputs.wnd.value = 30; inputs.lod.value = 50; inputs.bat.value = 200;
                gridActive = true;
                updateSliderFills();
                refreshSimulation();
                showToast('Reset to defaults ‚úì');
            };
            
            // Export functionality
            document.getElementById('btn-export').onclick = exportData;
            
            // Initialize slider fills
            updateSliderFills();
            
            refreshSimulation();
        }

        // Preset scenarios
        function applyPreset(scenario) {
            let scenarioName = '';
            switch(scenario) {
                case 'sunny':
                    inputs.sol.value = 95;
                    inputs.wnd.value = 20;
                    inputs.lod.value = 50;
                    gridActive = true;
                    scenarioName = 'Sunny Day';
                    break;
                case 'cloudy':
                    inputs.sol.value = 25;
                    inputs.wnd.value = 60;
                    inputs.lod.value = 50;
                    gridActive = true;
                    scenarioName = 'Cloudy Day';
                    break;
                case 'highdemand':
                    inputs.sol.value = 60;
                    inputs.wnd.value = 30;
                    inputs.lod.value = 120;
                    gridActive = true;
                    scenarioName = 'High Demand';
                    break;
                case 'night':
                    inputs.sol.value = 0;
                    inputs.wnd.value = 45;
                    inputs.lod.value = 70;
                    gridActive = true;
                    scenarioName = 'Nighttime';
                    break;
            }
            updateSliderFills();
            refreshSimulation();
            showToast(`${scenarioName} scenario applied ‚úì`);
        }

        // Export simulation data
        function exportData() {
            const d = calculateSimulation();
            const csvContent = [
                ['Hour', 'Solar (kW)', 'Wind (kW)', 'Load (kW)', 'Grid (kW)', 'Battery SoC (%)'],
                ...d.T.map((h, i) => [
                    h, 
                    d.solar[i].toFixed(2), 
                    d.wind[i].toFixed(2),
                    d.load[i].toFixed(2), 
                    d.gridHist[i].toFixed(2), 
                    d.socHist[i].toFixed(2)
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `heti-simulation-${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Data exported successfully ‚úì');
        }

        // Onboarding System
        let currentStep = 1;
        let userGoal = 'savings';
        let hasInteracted = false;
        
        function nextOnboardingStep() {
            const currentStepEl = document.querySelector(`.onboarding-step[data-step="${currentStep}"]`);
            const nextStepEl = document.querySelector(`.onboarding-step[data-step="${currentStep + 1}"]`);
            const dots = document.querySelectorAll('.onboarding-dot');
            const overlay = document.getElementById('onboarding-overlay');
            
            if (nextStepEl) {
                currentStepEl.classList.remove('active');
                nextStepEl.classList.add('active');
                dots[currentStep - 1].classList.remove('active');
                dots[currentStep].classList.add('active');
                currentStep++;
                
                // If moving to interactive step, switch to simulation tab and make overlay interactive
                if (currentStep === 3) {
                    switchTab('simulation');
                    overlay.classList.add('interactive'); // Allow clicks through overlay
                    
                    if (window.innerWidth <= 768) {
                        setTimeout(() => {
                            const sidebar = document.querySelector('aside');
                            const mobileOverlay = document.getElementById('mobile-overlay');
                            sidebar.classList.add('mobile-open');
                            mobileOverlay.classList.add('active');
                        }, 300);
                    }
                } else {
                    overlay.classList.remove('interactive'); // Block clicks on other steps
                }
            }
        }
        
        function selectGoal(goal) {
            userGoal = goal;
            
            // Update button styles
            const buttons = document.querySelectorAll('.goal-option');
            buttons.forEach(btn => {
                if (btn.dataset.goal === goal) {
                    btn.style.border = '2px solid #000';
                    btn.style.background = '#f8fafc';
                } else {
                    btn.style.border = '2px solid #e2e8f0';
                    btn.style.background = 'white';
                }
            });
            
            // Auto-advance after selection
            setTimeout(() => {
                nextOnboardingStep();
            }, 500);
        }
        
        function skipTutorial() {
            const overlay = document.getElementById('onboarding-overlay');
            overlay.classList.remove('active');
            switchTab('simulation');
        }
        
        function finishOnboarding() {
            const overlay = document.getElementById('onboarding-overlay');
            overlay.classList.remove('active');
            
            // Show welcome banner with user's goal
            const banner = document.getElementById('welcome-banner');
            const goalEmoji = document.getElementById('goal-emoji');
            const goalTitle = document.getElementById('goal-title');
            const goalDesc = document.getElementById('goal-description');
            
            if (userGoal === 'savings') {
                goalEmoji.textContent = 'üí∞';
                goalTitle.textContent = 'Optimizing for Cost Savings';
                goalDesc.textContent = 'Try adjusting the sliders or selecting a preset scenario to see how different conditions affect your savings!';
            } else if (userGoal === 'independence') {
                goalEmoji.textContent = 'üîã';
                goalTitle.textContent = 'Optimizing for Energy Independence';
                goalDesc.textContent = 'Watch how battery capacity and renewable generation help you reduce grid dependency!';
            } else {
                goalEmoji.textContent = '‚ö°';
                goalTitle.textContent = 'Optimizing for Backup Reliability';
                goalDesc.textContent = 'Try the "Simulate Storm" button to test how your system handles grid outages!';
            }
            
            banner.classList.add('show');
            setTimeout(() => {
                banner.classList.remove('show');
            }, 10000); // Hide after 10 seconds
            
            switchTab('simulation');
            showToast('Welcome to Heti! Start exploring üöÄ');
        }
        
        // Detect user interaction during onboarding
        function enableContinueButton() {
            if (!hasInteracted && currentStep === 3) {
                hasInteracted = true;
                const continueBtn = document.getElementById('continue-btn');
                const demoIcon = document.getElementById('demo-icon');
                const demoHint = document.getElementById('demo-hint');
                
                continueBtn.disabled = false;
                continueBtn.style.opacity = '1';
                continueBtn.style.cursor = 'pointer';
                
                demoIcon.textContent = '‚úÖ';
                demoHint.textContent = 'Great! You can see the changes in real-time';
                
                showToast('Perfect! You\'re getting the hang of it ‚úì');
            }
        }
        
        
        function startTutorial() {
            currentStep = 1;
            hasInteracted = false;
            
            // Reset all steps
            const steps = document.querySelectorAll('.onboarding-step');
            steps.forEach((step, index) => {
                if (index === 0) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
            
            // Reset dots
            const dots = document.querySelectorAll('.onboarding-dot');
            dots.forEach((dot, index) => {
                if (index === 0) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
            
            // Reset continue button
            const continueBtn = document.getElementById('continue-btn');
            if (continueBtn) {
                continueBtn.disabled = true;
                continueBtn.style.opacity = '0.5';
                continueBtn.style.cursor = 'not-allowed';
                continueBtn.textContent = 'Continue (adjust a slider first)';
            }
            
            // Reset demo elements
            const demoIcon = document.getElementById('demo-icon');
            const demoHint = document.getElementById('demo-hint');
            if (demoIcon) demoIcon.textContent = '‚òÄÔ∏è';
            if (demoHint) demoHint.textContent = 'Adjust the sliders in the left panel ‚Üí';
            
            // Show overlay
            const overlay = document.getElementById('onboarding-overlay');
            overlay.classList.add('active');
        }

        // Toggle mobile sidebar
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('aside');
            const overlay = document.getElementById('mobile-overlay');
            const menuBtn = document.getElementById('mobile-menu-btn');
            
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
            
            // Change icon
            const icon = menuBtn.querySelector('i');
            if (sidebar.classList.contains('mobile-open')) {
                icon.className = 'fa-solid fa-times';
            } else {
                icon.className = 'fa-solid fa-sliders';
            }
        }
        
        // Close mobile sidebar when overlay is clicked
        function closeMobileSidebar() {
            const sidebar = document.querySelector('aside');
            const overlay = document.getElementById('mobile-overlay');
            const menuBtn = document.getElementById('mobile-menu-btn');
            
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            
            const icon = menuBtn.querySelector('i');
            icon.className = 'fa-solid fa-sliders';
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Handle tooltip tap/click for mobile
        function initTooltips() {
            const tooltips = document.querySelectorAll('.tooltip-container');
            
            tooltips.forEach(container => {
                const icon = container.querySelector('.tooltip-icon');
                const tooltipText = container.querySelector('.tooltip-text');
                
                // Toggle on click/tap
                icon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // Close all other tooltips
                    tooltips.forEach(other => {
                        if (other !== container) {
                            other.classList.remove('active');
                        }
                    });
                    
                    // Toggle this tooltip
                    container.classList.toggle('active');
                    
                    // Position tooltip within viewport
                    if (container.classList.contains('active')) {
                        positionTooltip(icon, tooltipText);
                    }
                });
                
                // Position on hover for desktop
                icon.addEventListener('mouseenter', () => {
                    positionTooltip(icon, tooltipText);
                });
            });
            
            // Close tooltips when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.tooltip-container')) {
                    tooltips.forEach(container => {
                        container.classList.remove('active');
                    });
                }
            });
        }
        
        // Position tooltip to stay within viewport
        function positionTooltip(icon, tooltipText) {
            const iconRect = icon.getBoundingClientRect();
            const tooltipWidth = 220;
            const tooltipHeight = tooltipText.offsetHeight || 100;
            const padding = 10;
            
            // Calculate initial position (centered above icon)
            let left = iconRect.left + (iconRect.width / 2) - (tooltipWidth / 2);
            let top = iconRect.top - tooltipHeight - padding;
            
            // Adjust if tooltip goes off left edge
            if (left < padding) {
                left = padding;
            }
            
            // Adjust if tooltip goes off right edge
            if (left + tooltipWidth > window.innerWidth - padding) {
                left = window.innerWidth - tooltipWidth - padding;
            }
            
            // If tooltip goes off top, show it below the icon instead
            if (top < padding) {
                top = iconRect.bottom + padding;
            }
            
            // Apply position
            tooltipText.style.left = left + 'px';
            tooltipText.style.top = top + 'px';
        }

        window.onload = function() {
            initSimulation();
            initTooltips();

            // Keyboard arrow navigation between tabs
            document.querySelector('nav').addEventListener('keydown', function(e) {
                const tabs = [document.getElementById('tab-concept'), document.getElementById('tab-simulation')];
                const idx = tabs.indexOf(document.activeElement);
                if (idx === -1) return;
                if (e.key === 'ArrowRight' && idx < tabs.length - 1) {
                    e.preventDefault();
                    tabs[idx + 1].focus();
                    tabs[idx + 1].click();
                } else if (e.key === 'ArrowLeft' && idx > 0) {
                    e.preventDefault();
                    tabs[idx - 1].focus();
                    tabs[idx - 1].click();
                }
            });
            
            // Mobile menu button handler
            const menuBtn = document.getElementById('mobile-menu-btn');
            if (menuBtn) {
                menuBtn.addEventListener('click', toggleMobileSidebar);
            }
            
            // Mobile overlay handler
            const overlay = document.getElementById('mobile-overlay');
            if (overlay) {
                overlay.addEventListener('click', closeMobileSidebar);
            }
            
            // Close sidebar when a preset is clicked on mobile
            const presetButtons = document.querySelectorAll('.preset-btn');
            presetButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        setTimeout(closeMobileSidebar, 300);
                    }
                });
            });
        };
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ANIMATED ENVIRONMENT ENGINE
        // Reads solar slider ‚Üí paints sky, sun/moon, clouds, rain
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        (function() {
            const canvas = document.getElementById('env-canvas');
            const ctx = canvas.getContext('2d');
            let clouds = [], raindrops = [], animFrame;
            let isStorm = false; // set true when storm scenario is active

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resize);
            resize();

            // Seed clouds
            function seedClouds(count) {
                clouds = [];
                for (let i = 0; i < count; i++) {
                    clouds.push({
                        x: Math.random() * canvas.width * 1.3 - canvas.width * 0.15,
                        y: 60 + Math.random() * (canvas.height * 0.28),
                        w: 80 + Math.random() * 140,
                        h: 28 + Math.random() * 30,
                        speed: 0.15 + Math.random() * 0.25,
                        alpha: 0.55 + Math.random() * 0.35
                    });
                }
            }
            seedClouds(7);

            // Seed raindrops
            function seedRain(count) {
                raindrops = [];
                for (let i = 0; i < count; i++) {
                    raindrops.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        len: 12 + Math.random() * 18,
                        speed: 6 + Math.random() * 7,
                        alpha: 0.25 + Math.random() * 0.35
                    });
                }
            }
            seedRain(90);

            function getSolarVal() {
                const el = document.getElementById('s-sol');
                return el ? parseFloat(el.value) / 100 : 0.6;
            }
            function getWindVal() {
                const el = document.getElementById('s-wnd');
                return el ? parseFloat(el.value) / 100 : 0.3;
            }

            function lerp(a, b, t) { return a + (b - a) * t; }

            function drawSkyGradient(sol) {
                // Night (sol<0.08) ‚Üí Dawn (0.08-0.22) ‚Üí Day (0.22-0.78) ‚Üí Dusk (0.78-0.92) ‚Üí Night (>0.92)
                let topColor, botColor;
                if (sol < 0.08) {
                    topColor = {r:8, g:10, b:30};   botColor = {r:16, g:18, b:45};
                } else if (sol < 0.22) {
                    const t = (sol - 0.08) / 0.14;
                    topColor = {r: lerp(8,30,t)|0, g: lerp(10,60,t)|0, b: lerp(30,100,t)|0};
                    botColor = {r: lerp(16,180,t)|0, g: lerp(18,100,t)|0, b: lerp(45,60,t)|0};
                } else if (sol < 0.78) {
                    const t = (sol - 0.22) / 0.56;
                    topColor = {r: lerp(30,135,t)|0, g: lerp(60,200,t)|0, b: lerp(100,235,t)|0};
                    botColor = {r: lerp(180,200,t)|0, g: lerp(100,225,t)|0, b: lerp(60,250,t)|0};
                } else if (sol < 0.92) {
                    const t = (sol - 0.78) / 0.14;
                    topColor = {r: lerp(135,8,t)|0, g: lerp(200,10,t)|0, b: lerp(235,30,t)|0};
                    botColor = {r: lerp(200,180,1-t)|0, g: lerp(225,100,1-t)|0, b: lerp(250,60,1-t)|0};
                } else {
                    topColor = {r:8, g:10, b:30};   botColor = {r:16, g:18, b:45};
                }
                const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
                grad.addColorStop(0, `rgb(${topColor.r},${topColor.g},${topColor.b})`);
                grad.addColorStop(1, `rgb(${botColor.r},${botColor.g},${botColor.b})`);
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            function drawSun(sol) {
                if (sol < 0.06 || sol > 0.94) return; // fully dark
                const isMoon = sol < 0.15 || sol > 0.85;
                // arc position across sky
                const progress = Math.max(0, Math.min(1, (sol - 0.06) / 0.88));
                const sunX = canvas.width * (0.08 + progress * 0.84);
                const sunY = canvas.height * (0.32 - Math.sin(progress * Math.PI) * 0.22);
                const radius = isMoon ? 16 : 22;

                if (!isMoon) {
                    // Glow
                    const glow = ctx.createRadialGradient(sunX, sunY, 0, sunX, sunY, radius * 3.2);
                    glow.addColorStop(0, 'rgba(255,235,150,0.45)');
                    glow.addColorStop(0.5, 'rgba(255,200,80,0.12)');
                    glow.addColorStop(1, 'rgba(255,180,50,0)');
                    ctx.fillStyle = glow;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }

                ctx.beginPath();
                ctx.arc(sunX, sunY, radius, 0, Math.PI * 2);
                ctx.fillStyle = isMoon ? '#dde6f0' : '#fff7a0';
                ctx.fill();
            }

            function drawClouds(sol) {
                const windVal = getWindVal();
                const cloudCount = isStorm ? 11 : (sol < 0.25 || sol > 0.75 ? 5 : 7 + Math.round(windVal * 4));
                while (clouds.length < cloudCount) seedClouds(cloudCount);

                const isDark = sol < 0.15 || sol > 0.85;
                clouds.forEach(c => {
                    c.x += c.speed + (isStorm ? 0.6 : 0);
                    if (c.x - c.w > canvas.width) {
                        c.x = -c.w;
                        c.y = 50 + Math.random() * (canvas.height * 0.28);
                    }
                    const baseR = isStorm ? 55 : (isDark ? 40 : 210);
                    const baseG = isStorm ? 55 : (isDark ? 42 : 218);
                    const baseB = isStorm ? 60 : (isDark ? 55 : 230);
                    ctx.beginPath();
                    ctx.ellipse(c.x, c.y, c.w * 0.5, c.h * 0.5, 0, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(${baseR},${baseG},${baseB},${c.alpha})`;
                    ctx.fill();
                    // Second puff for volume
                    ctx.beginPath();
                    ctx.ellipse(c.x + c.w * 0.15, c.y - c.h * 0.12, c.w * 0.32, c.h * 0.42, 0, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(${baseR},${baseG},${baseB},${c.alpha * 0.7})`;
                    ctx.fill();
                });
            }

            function drawRain(sol) {
                const windVal = getWindVal();
                // Rain when: storm is active, OR wind > 75 and solar < 25
                const shouldRain = isStorm || (windVal > 0.75 && sol < 0.25);
                if (!shouldRain) return;

                const intensity = isStorm ? 1 : Math.min(1, (windVal - 0.75) / 0.25);
                const count = Math.round(60 + intensity * 50);
                while (raindrops.length < count) {
                    raindrops.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, len: 14 + Math.random() * 16, speed: 7 + Math.random() * 6, alpha: 0.2 + Math.random() * 0.3 });
                }

                ctx.strokeStyle = `rgba(170,200,230,${0.5 * intensity})`;
                ctx.lineWidth = 1.2;
                for (let i = 0; i < count && i < raindrops.length; i++) {
                    const r = raindrops[i];
                    r.y += r.speed;
                    r.x += 0.8; // slight wind drift
                    if (r.y > canvas.height) { r.y = 0; r.x = Math.random() * canvas.width; }
                    ctx.beginPath();
                    ctx.moveTo(r.x, r.y);
                    ctx.lineTo(r.x + 1.5, r.y + r.len);
                    ctx.stroke();
                }
            }

            function frame() {
                const sol = getSolarVal();
                // Detect storm: solar ‚â§ 5 AND grid is off (storm scenario sets both)
                isStorm = (sol <= 0.06 && !gridActive);

                canvas.classList.toggle('visible', document.getElementById('section-simulation') && !document.getElementById('section-simulation').classList.contains('hidden-section'));

                drawSkyGradient(sol);
                drawSun(sol);
                drawClouds(sol);
                drawRain(sol);

                animFrame = requestAnimationFrame(frame);
            }
            frame();
        })();
    </script>
</body>
</html>